:jbake-type: post
:jbake-status: published
:jbake-title: Java 9, tu modules ?
:jbake-tags: chtijug,java,_mois_sept.,_annÃ©e_2017
:jbake-date: 2017-09-20
:jbake-depth: ../../../../
:jbake-uri: wordpress/2017/09/20/java-9-tu-modules.adoc
:jbake-excerpt: 
:jbake-source: https://riduidel.wordpress.com/2017/09/20/java-9-tu-modules/
:jbake-style: wordpress

++++
<p>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/lhauspie" class="screenName"><img src="http://pbs.twimg.com/profile_images/1055741424539521026/8ksXipol_mini.jpg" alt="profile of Dev back @ZenikaLille.
<br/>
ğŸ–¥ï¸âŒ¨ï¸ğŸ–±ï¸
<br/>
Born to Code, Tech aficionado et Speaker Ã  mes heures perdues."/>lhauspie</a>
<br/>
<span class="name">Logan HAUSPIE ğŸ’»</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/lhauspie/status/910Â 251Â 497Â 358Â 860Â 288" class="date">19 sept. 2017 Ã  23:17:23</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">Super prez' @ChtiJUG de @RemiForaxOff sur la modularitÃ© de #Java 9 chez @LaRedouteFr sponsorisÃ© par @ZenikaLille ! https://t.co/J6Z0VU5pA0</span>
</p>
<p>
<span class="medias">
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/DKHc0vLW0AA_I8b.jpg" alt="910Â 251Â 398Â 280Â 957Â 952"/>
<br/>
</span>
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/DKHc3YZXUAMF6qC.jpg" alt="910Â 251Â 443Â 705Â 303Â 043"/>
<br/>
</span>
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
<br/>
<div class="sect1 data-line-3">
<br/>
<h2 id="truer_mi">RÃ©mi ?</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-4">
</p>
<p>
Vous connaissez RÃ©mi ? Il est maÃ®tre de confÃ©rences Ã  Marne la VallÃ©e, dÃ©veloppeur dâ€™<a href="http://asm.ow2.org/">ASM </a>(jâ€™ignorais Ã§a), dâ€™OpenJDK, expert pour le JCP (et clairement spÃ©cialiste des Ã©volutions du langage, pas la partie JavaEE) oÃ¹ il a ajoutÃ© invokedynamic, et a travaillÃ© sur les lambda, Jigsaw.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-6">
<br/>
<h2 id="truejava_9">Java 9</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-7">
</p>
<p>
Java 9 est la derniÃ¨re grosse release, parce que câ€™est pÃ©nible. Ca va Ãªtre remplacÃ© par une release tous les six mois â€¦â€‹ câ€™est un peu plus rapide. Et donc, dans six mois, on verra <code>var</code> apparaÃ®tre dans le langage Java.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-9">
<br/>
<h2 id="trueles_modules">Les modules</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-10">
</p>
<p>
Historiquement, Ã§a devait arriver en Java 6 ou 7 â€¦â€‹ Ca a pris un peu de retard.
</p>
<p>
</div>
<br/>
<div class="sect2 data-line-12">
<br/>
<h3 id="truepourquoi_modulariser">Qui veut modulariser le JDK ?</h3>
<br/>
<div class="paragraph data-line-13">
</p>
<p>
Il y a dâ€™une part des dÃ©veloppeurs du JDK qui veulent le faire Ã©voluer, mais ne peuvent pas Ã  cause de toutes les APIs qui utilisent des classes "cachÃ©es" du JDK. Et dâ€™autre part â€¦â€‹ des experts de sÃ©curitÃ© qui considÃ¨rent les failles de la plateforme.
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-15">
<br/>
<h3 id="trued_autres_probl_mes">Dâ€™autres problÃ¨mes</h3>
<br/>
<div class="sect3 data-line-16">
<br/>
<h4 id="truel_enfer_du_classpath">Lâ€™enfer du CLASSPATH</h4>
<br/>
<div class="paragraph data-line-17">
</p>
<p>
Sans outil pour gÃ©rer automatiquement le CLASSPATH (genre maven, gradle et autres), câ€™est lâ€™enfer. Par ailleurs, quand le ClassLoader charge une classe, il scanne linÃ©airement tous les jars et charge la premiÃ¨re classe quâ€™il trouve. Du coup, c'est long. Mais aussi super merdique quand on a deux versions du mÃªme artefact. Du coup, on aimerait bien que ce soit gÃ©rÃ© par la JVM. De la mÃªme maniÃ¨re, Ã©viter que les NoClassDefFoundError ne sortent qu'Ã  lâ€™exÃ©cution serait une bonne idÃ©e pour les dÃ©veloppeurs.
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect3 data-line-23">
<br/>
<h4 id="trueall_ger_java">AllÃ©ger Java</h4>
<br/>
<div class="paragraph data-line-24">
</p>
<p>
Ce serait sympa de pouvoir faire tourner le code Java sur des plateformes plus lÃ©gÃ¨res (typiquement pour lâ€™IoT). Personellement, Ã§a meparaÃ®t vaguement possible avec des outils comme <a href="https://www.guardsquare.com/en/proguard">ProGuard </a>de limiter la taille des dÃ©pendances, mais ce serait mieux dâ€™avoir Ã§a directement dans le JDK. Par exemple, rt.jar contient encore des parseurs XML (qui nâ€™ont pas Ã  Ãªtre des classes privilÃ©giÃ©es) ou CORBA (qui sâ€™en sert encore ?).
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect3 data-line-30">
<br/>
<h4 id="truecomment_modulariser">Comment modulariser ?</h4>
<br/>
<div class="paragraph data-line-31">
</p>
<p>
[caption id="attachment_5066" align="alignleft" width="500"]<img class=" size-full wp-image-5066 alignleft" src="https://riduidel.files.wordpress.com/2017/09/standards.png" alt="standards" width="500" height="283" /> Aucun rapport avec Java, bien sÃ»r[/caption]
</p>
<p>
Il y a dÃ©ja des standards de modules en Java
</p>
<p>
</div>
<br/>
<div class="ulist data-line-33">
<br/>
<ul>
<br/>
<li>maven</li>
<br/>
<li>gradle</li>
<br/>
<li>JBoss</li>
<br/>
<li>OSGi</li>
<br/>
<li>JavaEE</li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="paragraph data-line-41">
</p>
<p>
Du coup, Jigsaw doit fournir un systÃ¨me de modules compatible avec tous ces systÃ¨mes prÃ©Ã©existants. Ce qui implique tristement quâ€™il ne peuvent pas contenir de numÃ©ros de version. Et Ã§a, câ€™est moche.
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect3 data-line-43">
<br/>
<h4 id="truemodularisons_donc">Modularisons donc !</h4>
<br/>
<div class="sect4 data-line-44">
<br/>
<h5 id="truec_est_quoi_un_module">Câ€™est quoi un module ?</h5>
<br/>
<div class="paragraph data-line-45">
</p>
<p>
Dans un module, il y a
</p>
<p>
</div>
<br/>
<div class="ulist data-line-47">
<br/>
<ul>
<br/>
<li>des dÃ©pendances</li>
<br/>
<li>et des classes quâ€™on veut garder invisibles aux autres packages</li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="paragraph data-line-50">
</p>
<p>
Par exemple, java se est constituÃ© dâ€™un paquet de modules â€¦â€‹ dont java.compiler. Ce qui signifie quâ€™il nâ€™y a plus de distinctions JRE/JDK.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-52">
</p>
<p>
Tout Ã§a est dÃ©crit dans un module-info.java qui va Ãªtre compilÃ© comme le reste du code. Ca empÃªche les modifications ultÃ©rieures, ce qui est bien.
<br/>
A la compilation, il ne peut donc plus y avoir de "split-packages" (des packages dÃ©clarÃ©s dans deux JARS), ou de dÃ©pendances cycliques.
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect4 data-line-55">
<br/>
<h5 id="truequ_est_ce_qu_on_perd">Quâ€™est-ce quâ€™on perd ?</h5>
<br/>
<div class="ulist data-line-56">
<br/>
<ul>
<br/>
<li>les "split-package"</li>
<br/>
<li><code>setAccessible(true)</code> sur une classe dâ€™un module fermÃ©</li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="paragraph data-line-59">
</p>
<p>
Au passage, Ã§a permettra enfin Ã  RÃ©mi dâ€™optimiser les champs <code>final</code> (un truc dont j'Ã©tais sÃ»r quâ€™il existait dÃ©ja pourtant)
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-61">
</p>
<p>
Enfin, sauf si on active le flag <code>--illegal-access=permit</code> (qui est parfaitement clair). Notez quâ€™il y a dâ€™autres valeurs possibles (<code>warn</code>, <code>debug</code>). Bon, un jour, il disparaÃ®tra.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-63">
</p>
<p>
En bonus, les classes JavaEE cachÃ©s dans JavaSE (java.xml.bind, java.xml.ws et autres) ne seront plus dans le JDK. Notez que ces classes sont toujours accessibles via des dÃ©pendances Maven.
<br/>
Les classes <code>sun.</code> et <code>com.sun.</code> qui ne sont pas utilisÃ©es sont Ã©galement supprimÃ©es.
</p>
<p>
A noter : L'annotation <code>@ForRemovall</code> (je ne suis pas sÃ»r de l'orthographe) indique les classes qui seront supprimÃ©es dans la prochaine version du JDK. C'est une version Ã©tendue du classique <code>@Deprecated</code>.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-15">
<br/>
<div class="sect3 data-line-43">
<br/>
<div class="sect4 data-line-71">
<br/>
<h5 id="truecomment_trouver_les_d_pendances">Comment trouver les dÃ©pendances</h5>
<br/>
<div class="paragraph data-line-72">
</p>
<p>
Avec <a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/jdeps.html">jdeps</a>, par exemple, on peut facilement trouver toutes les dÃ©pendances dâ€™un module. Notez que cet outil existe dÃ©ja dans Java8.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect3 data-line-74">
<br/>
<h4 id="trueoui_mais_comment_je_transforme_mon_application_pour_java9">Oui, mais comment je transforme mon application pour Java9 ?</h4>
<br/>
<div class="paragraph data-line-76">
</p>
<p>
Pour Ã§a, RÃ©mi a dÃ©veloppÃ© son application de test : <a href="https://github.com/forax/moduletools">ModuleTools</a> qui lui permet de lire et d'Ã©crire un fichier <code>module-info.java</code> ou <code>module-info.class</code>.Et dans son application, il dÃ©clare quelques modules, qui dÃ©pendent tous de <code>java.base</code> (comme les classes Java dÃ©pendent de <code>java.lang.Object</code>).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-80">
</p>
<p>
Contrairement Ã  maven, un <code>require</code> de module nâ€™est pas transitif (contrairement Ã  maven). Du coup, il y a un require transitif, mais qui est limitÃ© Ã  un niveau.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-82">
</p>
<p>
En terme dâ€™organisation de fichiers, il est possible dâ€™avoir plusieurs organisations, dont par exemple plusieurs modules dans le mÃªme dossier (ce qui nâ€™est supportÃ© ni par maven, ni par gradle, ni par les IDE).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-84">
</p>
<p>
Il est possible de stocker la version du JAR dans le <code>module-info</code>, et de la rÃ©utiliser depuis le code, mais le systÃ¨me de modules nâ€™utilise pas la version.
</p>
<p>
</div>
<br/>
<div class="sect4 data-line-86">
<br/>
<h5 id="truecomment_utiliser_un_jar_non_modulaire">Comment utiliser un JAR non modulaire ?</h5>
<br/>
<div class="paragraph data-line-87">
</p>
<p>
Typiquement, une dÃ©pendance de Maven Central.On ne peut Ã©videment pas ajouter simplement le JAR dans le CLASSPATH. Il suffit en fait de mettre le jar dans le module-path, et Java va gÃ©nÃ©rer automatiquement un module-info, qui permet en plus Ã  ce module automatique de dÃ©pendre de JARs du CLASSPATH.Et comment sâ€™appelle ce module ? Soit le nom fourni dans le <code>MANIFEST.MF</code> comme <code>Automatic-Module-Name</code>, soit le nom du JAR sans le numÃ©ro de version. Du coup, en ce moment, sur GitHub, câ€™est la fÃªte Ã  lâ€™<a href="https://github.com/search?q=automatic-module-name&#38;type=Issues&#38;utf8=%E2%9C%93"><code>Automatic-Module-Name</code></a>. Au passage, il est possible dâ€™utiliser les JARs modulaires comme des JARs classiques, en les mettant dans le CLASSPATH !
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect4 data-line-95">
<br/>
<h5 id="truecomment_limiter_la_visibilit">Comment limiter la visibilitÃ© ?</h5>
<br/>
<div class="paragraph data-line-96">
</p>
<p>
Si on veut faire un module interne, il est possible de limiter sa visibilitÃ© Ã  certains modules spÃ©cifiques, et pas au monde entier. Câ€™est trÃ¨s chouette pour mieux gÃ©rer la sÃ©curitÃ©. Câ€™est ce quâ€™ont fait les dÃ©veloppeurs du JDK pour la tristement cÃ©lÃ¨bre <code>sun.misc.Unsafe</code> dont une partie a Ã©tÃ© dÃ©placÃ©e dans <code>jdk.unsupported</code>, et une autre partie dans un <code>jdk.internal.misc</code>. Du coup, la rÃ©flexion nâ€™est plus possible sur les champs privÃ©s (dommage pour <a href="https://github.com/Riduidel/gaedo">gaedo</a>). Câ€™aurait Ã©tÃ© pÃ©nible pour JPA â€¦â€‹ mais les fournisseurs dâ€™implÃ©mentation JPA utilisent des agents qui changent le code avant son exÃ©cution. Cela dit, la rÃ©flexion reste possible grÃ¢ce Ã  <code>open</code> sur un package ou sur le module.Par ailleurs, le trÃ¨s moche <a href="https://docs.oracle.com/javase/8/docs/api/index.html?java/util/ServiceLoader.html"><code>ServiceLoader</code></a> a Ã©tÃ© Ã©tendu pour fonctionner avec les modules â€¦â€‹ La diffÃ©rence, câ€™est que la description est un peu propre et intÃ©grÃ©e au <code>module-info</code>. Et la description Ã  la fois des fournisseurs dâ€™implÃ©mentation et de lâ€™utilisation de ces implÃ©mentations doit Ãªtre fournie. Câ€™est super cool, parce que Ã§a permet de <strong>tester</strong> les injections de dÃ©pendances.
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect4 data-line-104">
<br/>
<h5 id="truepackager">Packager ?</h5>
<br/>
<div class="paragraph data-line-105">
</p>
<p>
Avec jlink, on peut crÃ©er une image Ã  la volÃ©e de lâ€™application et de ses dÃ©pendances. Pratique pour lâ€™embarquÃ©, Ã©videment, mais aussi pour Docker. HÃ©las, il ne peut pas y avoir de modules automatiques, parce quâ€™avec ces modules automatiques, il faut embarquer tout le JDK, et Ã§a limite en plus Ã©normÃ©ment les possibilitÃ©s dâ€™optimisation de jlink. Câ€™est un peu la carotte de Jigsaw. Ca permet aussi dâ€™utiliser une JVM minimale <strong>de 3 Mo !</strong>. Bon, sans JIT, mais sur un Raspberry, câ€™est pas vraiment utile. Ca permet aussi de garantir la durÃ©e dâ€™exÃ©cution â€¦â€‹ avec jaotc, qui gÃ©nÃ¨re du code natif (qui pourra mÃªme se passer de JIT). Le but Ã  terme de cette expÃ©rience est (accrochez-vous) <strong>de rÃ©Ã©crire la JVM en Java</strong> (pour se dÃ©barasser du code C++).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-108">
</p>
<p>
Evidement jlink (et lâ€™ahead-of-time-compiling) est chouette pour les performances. Et pour lâ€™espace disque.
<br/>
<h2>Conclusion</h2>
<br/>
Modulariser, Ã§a n'est pas si facile, Ã  la fois pour les implÃ©menteurs et les utilisateurs. A ce sujet, la conclusion de RÃ©mi est parfaitement claire : si vous avez une application non-modulaire, n'essayez pas de la modulariser. C'est Ã  la fois long, complexe, et sans valeur ajoutÃ©e. En revanche, si vous vous lancez dans une nouvelle application, la modulariser dÃ¨s le dÃ©part peut Ãªtre utile.
</p>
<p>
Et merci Ã  nos amis du chtijug pour une soirÃ©e sans faille, dans une super salle, et avec une vue vraiment chouette !
</p>
<p>
<div class='twitter'>
<br/>
https://twitter.com/cyril_lakech/status/910196474344067073
<br/>
</div>
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
</div>
<br/>
</div>
<br/>
</div>
</p>
++++