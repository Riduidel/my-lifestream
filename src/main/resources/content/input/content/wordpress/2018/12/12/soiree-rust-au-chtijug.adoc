:jbake-type: post
:jbake-status: published
:jbake-title: SoirÃ©e Rust au chtijug
:jbake-tags: chtijug,rust,web,_mois_dÃ©c.,_annÃ©e_2018
:jbake-date: 2018-12-12
:jbake-depth: ../../../../
:jbake-uri: wordpress/2018/12/12/soiree-rust-au-chtijug.adoc
:jbake-excerpt: 
:jbake-source: https://riduidel.wordpress.com/2018/12/12/soiree-rust-au-chtijug/
:jbake-style: wordpress

++++
<p>
<div id="preamble">
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-3">
</p>
<p>
Ca nâ€™est pas le Chtirug, mais Ã§a pourrait, puisquâ€™on va faire du Rust ce soir. Et câ€™est cool, parce que le Rust, jâ€™aime bien !
</p>
<p>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/hsablonniere" class="screenName"><img src="http://pbs.twimg.com/profile_images/854028880046379008/Bm-ygvTm_mini.jpg" alt="profile of ğŸ˜œ Curious and passionate Web developer working for ğŸ’¡â˜ï¸ @clever_cloud"/>hsablonniere</a>
<br/>
<span class="name">Hubert SABLONNIÃˆRE</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/hsablonniere/status/1Â 072Â 553Â 907Â 266Â 695Â 168" class="date">11 dÃ©c. 2018 Ã  19:09:13</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">ğŸ¤£ Un MontpelliÃ©rain chez les Ch'tis
<br/>
ğŸ¦€ @fteychene nous parle de @rustlang  au @chtijug https://t.co/eSw4Rxwng4</span>
</p>
<p>
<span class="medias">
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/DuJ6EaZXcAENbgd.jpg" alt="1Â 072Â 553Â 877Â 491Â 380Â 225"/>
<br/>
</span>
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-6">
</p>
<p>
FranÃ§ois est <a href="https://riduidel.wordpress.com/2018/06/21/devfest-lille-3-lux-a-sauve-mon-devops/">dÃ©ja venu Ã  Lille pour le devfest</a> (et c'Ã©tait bien).
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-8">
<br/>
<h2 id="truec_est_quoi_rust">Câ€™est quoi Rust ?</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-10">
</p>
<p>
Pour FranÃ§ois câ€™est un langage systÃ¨me rapide qui Ã©vite les <a href="https://fr.wikipedia.org/wiki/Erreur_de_segmentation">SEGFAULT</a> et qui facilite la thread safety. Et lâ€™intÃ©rÃªt pour FranÃ§ois, câ€™est lâ€™exÃ©cution sÃ»re, la performance et lâ€™expressivitÃ© du langage.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-13">
</p>
<p>
La magie vient de trois Ã©lÃ©ments
</p>
<p>
</div>
<br/>
<div class="olist arabic data-line-15">
<br/>
<ol class="arabic">
<br/>
<li>Ownership</li>
<br/>
<li>Borrowing</li>
<br/>
<li>Lifetime</li>
<br/>
</ol>
<br/>
</div>
<br/>
<div class="paragraph data-line-19">
</p>
<p>
Et FranÃ§ois va tout faire pour les Ã©viter (je le comprend, ce sont des concepts loin d'Ãªtre Ã©vidents pour les dÃ©butants â€¦â€‹ qui ne prÃ©sentent de lâ€™intÃ©rÃªt que quand on code un peu salement). Dâ€™ailleurs FranÃ§ois (comme moi, dans une moindre mesure) essaye rÃ©guliÃ¨rement de proposer aux gens de dÃ©velopper en Rust.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-23">
</p>
<p>
Curieusement, quand FranÃ§ois a commencÃ© a faire du Rust, le compilateur passait son temps Ã  lui dire "non". Donc Rust a des killer features. En plus, Avec Rust, "it compiles, it run". Et <a href="https://doc.rust-lang.org/book/second-edition/">la doc de Rust</a> est canon (le mot est faible, en fait).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-28">
</p>
<p>
Malheureusement, Rust est prÃ©sentÃ© comme un langage systÃ¨me â€¦â€‹ ce dont tout le monde se cogne (sauf Clever Cloud). Et pour faire du web, Ã§a paraÃ®t inappropriÃ© â€¦â€‹ Pourtant, câ€™est ce qui est arrivÃ© Ã  go : câ€™est un langage pensÃ© pour remplacer C â€¦â€‹ et maintenant on sâ€™en sert pour remplacer Java. Et FranÃ§ois veut quâ€™on considÃ¨re Rust de la mÃªme maniÃ¨re.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-33">
<br/>
<h2 id="truele_sujet">Le sujet</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-35">
</p>
<p>
A Montpellier, pour faire gagner les places, ils ont une lotterie : ils rÃ©cupÃ¨rent la liste des spectateurs dans EventBrite, et tirent au sort "n" gagnants.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-38">
</p>
<p>
Et FranÃ§ois va donc nous montrer la v3 de cette application. Et câ€™est cool, parce que du coup, <a href="https://github.com/fteychene/lottery-jug-rust">le code est sur GitHub</a> !
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-41">
</p>
<p>
On commence par <a href="https://doc.rust-lang.org/cargo/">Cargo</a>, qui est lâ€™outil de build Rust. Cargo existe dÃ¨s le dÃ©but de Rust (Ã  la diffÃ©rence de Go â€¦â€‹ par exemple).
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-44">
<br/>
<h2 id="trueappeler_eventbrite">Appeler EventBrite</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-46">
</p>
<p>
Classiquement, FranÃ§ois utiliser <a href="https://docs.rs/reqwest/0.9.5/reqwest/">reqwest</a> pour faire les appels HTTP, et <a class="bare" href="https://boats.gitlab.io/failure/Failure">Failure</a>, pour avoir de beaux messages dâ€™erreur (parce que par dÃ©faut, on nâ€™a <a href="https://doc.rust-lang.org/book/ch09-00-error-handling.html">Ã  peu prÃ¨s</a> que <code>panic!</code>). Ah, et <a href="https://serde.rs/">Serde</a>, bien sÃ»r, pour (dÃ©)sÃ©rialiser.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-49">
</p>
<p>
Lâ€™avantage de reqwest, câ€™est quâ€™avec une fonction, on fait des HTTP GET. Câ€™est un peu mieux quâ€™en Java, encore aujourdâ€™hui â€¦â€‹<code>reqwest::get</code> retourne un <code>Result</code>, qui peut donc Ãªtre <code>Ok</code> ou <code>Error</code>. En tapant <code>reqwest::get(â€¦â€‹)?</code>, si le rÃ©sultat est un <code>Error</code>, on sort tout de suite de la fonction (au lieu dâ€™avoir Ã  vÃ©rifier Ã  chaque ligne quâ€™on a une erreur â€¦â€‹ un peu comme en go). Il faut en fait retenir que si votre fonction peut retourner des erreurs, elle doit retourner un <code>Result</code>.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-55">
</p>
<p>
De la mÃªme maniÃ¨re, il nâ€™y a pas de <code>null</code> en Rust. Du coup, comme dans dâ€™autres langages, on retourne une <code>Option</code>.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-58">
</p>
<p>
Pour un langage qui est rÃ©putÃ© Ãªtre bas-niveau, lire une liste de spectateurs paginÃ©e est assez facile, grÃ¢ce aux Ã©lÃ©ments fonctionnels (comme le <code>map(â€¦â€‹)</code> et le <code>flatMap(â€¦â€‹)</code>).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-60">
</p>
<p>
Evidement, on peut lire les variables dâ€™environnement avec <code>env::var(â€¦â€‹)</code> qui retourne Ã©videment un <code>Result</code> pour le cas oÃ¹ la variable nâ€™existe pas. Et quand elle nâ€™existe pas, on peut gÃ©nÃ©rer facilement une erreur avec <code>Result.expect("le message dâ€™erreur")</code>.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-63">
</p>
<p>
Une fois quâ€™on a rÃ©cupÃ©rÃ© tout Ã§a, il peut Ãªtre utile de transcoder avec <code>From</code> et <code>Into</code>
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-65">
<br/>
<h2 id="truetirer_au_sort_les_gagnants">Tirer au sort les gagnants</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-67">
</p>
<p>
Pour tirer au sort les gagnants, on fait un petit coup de <a href="https://doc.rust-lang.org/book/ch18-00-patterns.html">pattern matching</a>, qui marche assez facilement en Rust.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-69">
</p>
<p>
Par contre, pour rÃ©cupÃ©rer un <code>Vec</code> avec le bon lifetime, FranÃ§ois nous fait un bout de code un peu sale. Parce que <code>clone()</code>, câ€™est sale au sens oÃ¹ on copie le contenu de la mÃ©moire dâ€™un endroit Ã  un autre. Et câ€™est le genre dâ€™endroit oÃ¹ le cÃ´tÃ© bas-niveau de Rust pique : Java fait Ã§a souvent, mais on ne le voit jamais.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-73">
<br/>
<h2 id="trueexposer_ce_r_sultat_en_http">Exposer ce rÃ©sultat en HTTP</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-75">
</p>
<p>
FranÃ§ois le fait avec <a href="https://actix.rs/">actix-web</a>, qui fournit une API web â€¦â€‹ et des acteurs. Un bon point pour actix-web : la crÃ©ation dâ€™erreurs HTTP Ã  partir dâ€™erreurs mÃ©tier est assez intuitive. Et en bonus, Ã©videment, tout le code mÃ©tier peut Ãªtre appelÃ© de faÃ§on asynchrone facilement.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-79">
</p>
<p>
Câ€™est conceptuellement trÃ¨s bien, mais je ne suis pas fan dâ€™actix-web : la dÃ©finition des routes nâ€™est pas super lisible, et les contraintes liÃ©es au dÃ©marrage du systÃ¨me dâ€™acteurs ne sont pas super chouettes. Jâ€™aurais tendance Ã  prÃ©fÃ©rer <a href="https://rocket.rs/">rocket</a>, par exemple â€¦â€‹ (juste parce que comme en Java, il utilise des annotations pour dÃ©finir les routes, et que je trouve Ã§a cool).
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-82">
<br/>
<h2 id="trueajouter_un_cache">Ajouter un cache</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-84">
</p>
<p>
LÃ , câ€™est facile grÃ¢ce Ã  actix-web : il suffit dâ€™ajouter un acteur de cache, et le connecter Ã  notre API.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-86">
</p>
<p>
Bon, jâ€™ai vu quelques <code>&#38;&#38;</code> qui sont assez mauvais signes en termes de gestion mÃ©moire, mais rien dâ€™insurmontable dans de lâ€™informatique web. Autrement dit, câ€™aurait Ã©tÃ© gÃªnant pour un driver ou un OS, mais pour une appli web qui lit EventBrite, franchement, Ã§a nâ€™est pas bien grave.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-89">
</p>
<p>
Et avec le cache, Ã§a va quand mÃªme sacrÃ©ment vite !
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-91">
<br/>
<h2 id="truemettre_jour_le_cache">Mettre Ã  jour le cache</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-93">
</p>
<p>
Pour Ã§a, il suffit dâ€™utiliser <a href="https://tokio.rs/">Tokio</a> (parce quâ€™actix-web se base sur Tokio). Et avec Tokio, on peut demander Ã  Rust de lancer, en asynchrone, un bout de code qui sâ€™exÃ©cutera toutes les 5 secondes pour rafraÃ®chir le cache. Curieusement, FranÃ§ois utilise le mot clÃ© <code>move</code>, qui ne fait plus partie du langage.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-97">
<br/>
<h2 id="trueconteneuriser">Conteneuriser</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-99">
</p>
<p>
Evidement, mettre du Rust dans un conteneur, câ€™est facile, parce que lâ€™exÃ©cutable peut se compiler comme go sans dÃ©pendance systÃ¨me. Par contre, comme FranÃ§ois embarque une base sqlite et libssl, il lui faut des dÃ©pendances systÃ¨me â€¦â€‹ et pour se faciliter la vie, il prend celles dâ€™Ubuntu.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-102">
<br/>
<h2 id="truele_mot_de_la_fin_de_fran_ois">Le mot de la fin de FranÃ§ois</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-104">
</p>
<p>
En une heure, il nous a montrÃ© une application facile qui expose nÃ©anmoins les problÃ¨mes classiques des applciations web
</p>
<p>
</div>
<br/>
<div class="ulist data-line-106">
<br/>
<ul>
<br/>
<li>Une api HTTP</li>
<br/>
<li>Une gestion d'Ã©tat</li>
<br/>
<li>Un client HTTP</li>
<br/>
<li>Une gestion des erreurs avancÃ©e</li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="paragraph data-line-111">
</p>
<p>
Vous nâ€™allez pas tout recoder en Rust, parce que Ã§a nâ€™est pas facile. Mais vous allez apprendre beaucoup, notament sur la gestion de la mÃ©moire. Et curieusement, pour une appli web simple, vous nâ€™avez pas besoin de vous intÃ©resser de trop au borrow checker et aux lifetimes.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-115">
</p>
<p>
Pour le dire autrement, ce que vous faites en Go, vous pouvez le faire en Rust, avec de meilleures garanties au runtime (de qualitÃ© de code, de sÃ©curitÃ©).
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-117">
<br/>
<h2 id="trueconclusion">Conclusion</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-118">
</p>
<p>
J'Ã©tais conquis par Rust avant la prÃ©sentation, donc c'Ã©tait facile. Je retire nÃ©anmoins plusieurs choses de cette prÃ©sentation. Dâ€™abord, que faire des <code>.clone()</code>, Ã§a nâ€™est pas si dramatique. Câ€™est Ã©videment moins bien que de sâ€™en passer, mais Ã§a nâ€™est pas la fin du monde. Ensuite, que malgrÃ© lâ€™aspect un peu rÃ©barbatif de la compilation qui ne marche jamais du premier coup, on peut faire des applis web en Rust qui dÃ©potent. Enfin, et câ€™est le plus important, Rust va continuer Ã  grandir parce quâ€™il offre une bien plus grande garantie Ã  lâ€™exÃ©cution que dâ€™autres langages. Et Ã§a, câ€™est Ã  mon avis le plus important, puisque câ€™est ce qui permet de limiter les frais de maintenance logicielle (typiquement, quand on Ã©crit du Rust, si Ã§a compile, Ã§a marche). Entre Ã§a et lâ€™utilisation possible de Rust dans AWS Lambda, jâ€™ai lâ€™impression quâ€™il commence Ã  se passer quelque chose dâ€™intÃ©ressant â€¦â€‹
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
</p>
++++