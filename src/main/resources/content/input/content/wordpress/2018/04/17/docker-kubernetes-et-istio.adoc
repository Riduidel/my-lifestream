:jbake-type: post
:jbake-status: published
:jbake-title: Docker, Kubernetes et Istio
:jbake-tags: architecture,chtijug,docker,kubernetes,_mois_avr.,_ann√©e_2018
:jbake-date: 2018-04-17
:jbake-depth: ../../../../
:jbake-uri: wordpress/2018/04/17/docker-kubernetes-et-istio.adoc
:jbake-excerpt: 
:jbake-source: https://riduidel.wordpress.com/2018/04/17/docker-kubernetes-et-istio/
:jbake-style: wordpress

++++
<p>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/cyrillegrifo" class="screenName"><img src="http://pbs.twimg.com/profile_images/551757806320107520/6UqWoGUE_mini.jpeg" alt="profile of Artisan du web, manager au Webcenter @AXA et d√©veloppeur la nuit #eCommerce #Mobile #InternetOfThings #MaisonConnect√©e #CleanCode #ContinuousDelivery #Agile"/>cyrillegrifo</a>
<br/>
<span class="name">Cyrille GRIFO</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/cyrillegrifo/status/985¬†928¬†790¬†823¬†133¬†185" class="date">16 avr. 2018 √† 19:11:56</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">Ce soir session #Docker #Kubernetes au #ChtiJug avec @dgageot https://t.co/1tulOeKoC8</span>
</p>
<p>
<span class="medias">
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/Da64_oCXcAEKx1R.jpg" alt="985¬†928¬†771¬†659¬†329¬†537"/>
<br/>
</span>
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
<br/>
<div id="preamble">
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-3">
</p>
<p>
Docker, K8s (j‚Äôabr√®ge, hein, parce que bon) sont souvent pr√©sent√©s pour les microservices, mais √ßa marche aussi avec les applications un peu plus grosses. C‚Äôest ce que David va montrer avec le <a href="https://github.com/agoncal/agoncal-application-petstore-ee7">petstore version A. Goncalvez</a>.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-6">
<br/>
<h2 id="truedockeriser">Dockeriser</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-7">
</p>
<p>
Pou √ßa, David construit son image Docker avec un <a href="https://blog.mikesir87.io/2017/03/introducing-docker-multi-stage-builds/">multi-stage build</a> (toujours impressionant pour le dockeriste d√©butant comme moi). Et paf, l‚Äôapplication est conteneuris√©e.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-9">
<br/>
<h2 id="truelancer_dans_un_cluster_k8s">Lancer dans un cluster K8s</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-11">Vous connaissez Kubernetes ? ? non ? bon, David a une surprise pour vous</div>
<br/>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/dgageot" class="screenName"><img src="http://pbs.twimg.com/profile_images/1253031877532880906/9Ix8j4ic_mini.jpg" alt="profile of Chaotic French Speaker. Chief Architect @Doctolib. We are hiring https://t.co/Lr16lL5MKr"/>dgageot</a>
<br/>
<span class="name">David Gageot</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/dgageot/status/938¬†357¬†685¬†484¬†957¬†696" class="date">6 d√©c. 2017 √† 11:41:20</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">Do you remember the comic intro to Chrome? Did you enjoy it? I did! Now there‚Äôs a comic intro to #Kubernetes! https://t.co/6LwyG3Yc2L</span>
</p>
<p>
<span class="medias">
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
<br/>
<div class="paragraph data-line-11">Avec K8s, on peut prendre un cluster de machines et travailler dessus sans trop s‚Äôen soucier. Pour lancer notre application, on cr√©e deux descripteurs yaml (ouch, j‚Äôaime aussi peu que David).</div>
<br/>
<div class="olist arabic data-line-14">
<br/>
<ol class="arabic">
<br/>
<li>Un d√©ploiement (qui d√©crit l‚Äôapplication √† d√©ployer)</li>
<br/>
<li>Un service (qui route le port 80 vers notre application - √† la <a href="https://traefik.io/">traefik</a>/https://nginx.org/[nginx]/https://getkong.org/[kong]/https://www.sozu.io/[sozu]/‚Ä¶‚Äã.)</li>
<br/>
</ol>
<br/>
</div>
<br/>
<div class="paragraph data-line-17">
</p>
<p>
Et paf, on d√©ploie. L‚Äôexplication sur le mode de fonctionnement de K8s est un peu louche (√† base de boucles de contr√¥le qui r√©concilient des √©tats souhait√©s/actuels).
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-19">
<br/>
<h2 id="trueorganisation">Organisation</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-20">
</p>
<p>
La CLI de K8s permet d‚Äôavoir des informations sur l'√©tat du cluster, et nous montre par exemple que l‚Äôapplication tourne dans un pod. Si ce pod est d√©truit, K8s en relance un nouveau, et y red√©ploie l‚Äôapplication. C‚Äôest tr√®s tr√®s cool. On peut aussi facilement d√©ployer l‚Äôapplication dans plusieurs pods, pour faire de la redondance dans ce que √ßa a de plus vrai : arr√™ter ou perdre un pod n‚Äôa aucun impact sur l‚Äôautre.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-24">
<br/>
<h2 id="trueam_liorer_l_appllication_de_l_ext_rieur">Am√©liorer l‚Äôappllication de l‚Äôext√©rieur</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-25">
</p>
<p>
David ajoute maintenant un proxy <a href="https://nginx.org/">nginx</a> pour gzipper le flux, ajouter une page 404 et r√©√©crire les urls. Pour √ßa, il suffit d‚Äôajouter le proxy dans le pod de l‚Äôapplication. Ca veut dire un d√©ploiement et un service d√©crivant nginx, un dockerfile et enfin fichier de configuration pour nginx. La particularit√©, c‚Äôest que nginx reroute vers localhost (ce qui n‚Äôest pas le cas quand on joue classiquement avec des conteneurs). Parce que nginx et petstore seront forc√©ment d√©ploy√©es sur la m√™me machine. Enfin, en ajoutant un <a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">ingress</a>, il est possible de cr√©er un nom de domaine sp√©cifique devant le nginx. C‚Äôest vachement pratique, parce que pendant ce temps-l√†, petstore n‚Äôa pas chang√©.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-32">
<br/>
<h2 id="trueistio">Istio</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-33">
</p>
<p>
<a href="https://istio.io/">Istio</a> reprend pr√©cis√©ment ce principe en ajoutant des facades envoy (un proxy C++) devant toutes les applications. Le proxy est configurable.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-36">
</p>
<p>
Premier apport : Istio transforme tous les flux en HTTPS. C‚Äôest dingue. C‚Äôest √† la fois g√©nial et affreux : comment d√©bugger le traffic ?
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-39">
</p>
<p>
Gr√¢ce √† envoy, Istio fournit de monitoring de tous les services avec les temps de r√©ponse,
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-41">
</p>
<p>
David passe √† une d√©mo o√π les deux versions de l‚Äôapplication sont d√©ploy√©es c√¥te √† c√¥te avec des urls diff√©rentes. Et gr√¢ce au smart routing d‚ÄôIstio, on peut faire du blue-green deployment. Alors qu‚Äôavec K8s, c‚Äôest impossible. Bon, apparement, il y a d‚Äôautres solutions (de m√©moire, OpenShift le fait aussi comme l‚Äôavait montr√© <a href="https://riduidel.wordpress.com/2017/06/02/hop-hop-hop-un-chtijug/">Cl√©ment Escoffier pr√©c√©dement</a>). Pour v√©rifier qu‚Äôon a bien du blue-green, David affiche un dashboard grafana (install√© par Istio) en ouvrant un tunnel de sa machine vers le composant Grafana (assez spectaculaire). Et √ßa marche ! On a bien 20% d‚Äôutilisateurs en v2 et 80% en v1.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-47">
<br/>
<h2 id="trueroutage">Routage</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-48">
</p>
<p>
Et maintenant, il est temps de tout r√©√©crire. David va donc s√©parer l‚Äôapplication en plusieurs services, qui utiliseront toujours les routes de l‚Äôapplication initiale. Pour √ßa, le smart routing d‚ÄôIstio est pratique ‚Ä¶‚Äã mis √† part le fait qu‚Äôil y a de plus en plus de contenu YAML. Donc on a deux composants, qui se parlent √† travers le r√©seau. Et forc√©ment, avec le r√©seau, les probl√®mes arrivent. Heureusement, Istio va nous aider pour survivre √† √ßa. D‚Äôabord gr√¢ce √† un graphe des services (auquel on se connecte comme Grafana gr√¢ce √† un tunnel temporaire). Et l√†, trop bien ‚Ä¶‚Äã mais trop moche ‚Ä¶‚Äã le graphe est g√©n√©r√© par Grafviz (mais la version plus r√©cente utilise D3.js).
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-56">
<br/>
<h2 id="truegestion_du_r_seau">Gestion du r√©seau</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-57">
</p>
<p>
Encore une fois, gr√¢ce au proxy envoy, on peut configurer finement chaque composant pour, par exemple, simuler des timeouts. Ou de mirrorer le trafic de prod vers une application non utilis√©e en prod, mais qui en recevra la charge. Ou encore d‚Äôindustrialiser les circuit breakers en les pla√ßant au niveau d‚Äôenvoy. Ou encore de g√©rer la s√©curit√© sans passer par les notions classiques et p√©nibles de zones de s√©curit√© r√©seau, mais en utilisant une gestion de la s√©curit√© par r√¥le. C‚Äôest vraiment chouette parce que √ßa permet d‚Äôoptimiser le nombre de serveurs. Ca permet √©galement, gr√¢ce √† la t√©l√©m√©trie, de voir quel composant appelle quel autre service. Pour ceux qui connaissent, √ßa ressemble vachement √† Dynatrace dans l‚Äôid√©e.
</p>
<p>
</div>
<br/>
<div class="sect2 data-line-65">
<br/>
<h3 id="truerate_limiting">Rate limiting</h3>
<br/>
<div class="paragraph data-line-66">
</p>
<p>
En particulier, il est possible de limiter les appels √† un service pour qu‚Äôil ne soit pas noy√© sous la charge. Malheureusement, encore une fois, il faut des paquets de YAML.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-69">
<br/>
<h2 id="trueconclusion">Conclusion</h2>
<br/>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/ClementDevos" class="screenName"><img src="http://pbs.twimg.com/profile_images/1085874552830332929/Hc5_fEy2_mini.jpg" alt="profile of JS Developer @WeLoveDevs, France.
<br/>
Likes üç∫,üéß and üöô but also üö¥‚Äç‚ôÇÔ∏è"/>ClementDevos</a>
<br/>
<span class="name">Cl√©ment Devos üë™</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/ClementDevos/status/985¬†938¬†839¬†612¬†088¬†326" class="date">16 avr. 2018 √† 19:51:51</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">That's it for today! @dgageot nous a bien parl√© de Legos avec k8s et istio! Cc @chtijug #clustering https://t.co/47024Hxjfe</span>
</p>
<p>
<span class="medias">
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/Da7CI62XUAE_ocz.jpg" alt="985¬†938¬†826¬†932¬†736¬†001"/>
<br/>
</span>
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-70">
</p>
<p>
J‚Äôai loup√© la s√©ance de questions, parce que je devais aller chercher les bi√®res, mais c‚Äôest pas grave, lan√ßons-nous. Docker est un outil un peu chiant, mais tr√®s pratique pour les petits ops. Docker est aussi issu d‚Äôid√©es (conteneurs et c-groups) sur lesquels Google bosse depuis ‚Ä¶‚Äã. des ann√©es. Donc forc√©ment, leur outil de gestion de flotte int√®gre un niveau de complexit√© sup√©rieur (l‚Äôabstraction des pods semble par exemple pratique, mais d√©licate √† aborder). Et √©videment, c‚Äôest difficile √† comprendre pour un non averti comme moi. En revanche, cette complexit√© permet le d√©ploiement d‚Äôoutils comme istio, qnui est la killer feature de K8s. Rien que pour donner un exemple, il semble possible pour une entreprise de se d√©barasser de Dynatrace (dont les licences tournent autour de 100000‚Ç¨/serveur/an). Sans compter toutes les possibilit√©s de debug qui sont, dans le monde des conteneurs, aussi indispensables qu‚Äôintrouvables. Autrement dit, K8s me tente peu, mais Istio le rend supportable.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/cfurmaniak" class="screenName"><img src="http://pbs.twimg.com/profile_images/1321735109721100289/w-vEMG2t_mini.jpg" alt="profile of I've got the DevOps haircut in my mind. Bring me a problem and I will throw a lot of questions at your face."/>cfurmaniak</a>
<br/>
<span class="name">Christophe Furmaniak</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/cfurmaniak/status/984¬†414¬†527¬†247¬†802¬†372" class="date">12 avr. 2018 √† 14:54:47</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">@DevOpsAtLille @cyril_lakech @chtijug @Docker @kubernetesio @IstioMesh @dgageot @Adeo @ZenikaLille @GDGLille @ovh_fr et pour ceux qui le louperont au @chtijug, il sera aussi au #devfestlille du @GDGLille il me semble...</span>
</p>
<p>
<span class="medias">
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
</p>
<p>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/chtijug" class="screenName"><img src="http://pbs.twimg.com/profile_images/1179656487326617600/2uFfDuut_mini.jpg" alt="profile of Le Java User Group des Ch'tis d'un Ch'nord"/>chtijug</a>
<br/>
<span class="name">Ch'ti JUG</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/chtijug/status/986¬†296¬†089¬†161¬†682¬†946" class="date">17 avr. 2018 √† 19:31:26</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">Si vous avez loup√© le 4√®me passage de @dgageot au @chtijug hier soir chez @adeo
<br/>
Peut-√™tre vous laisserez vous tenter par une relecture oklm?
<br/>
C'est par l√† que √ßa se passe üé•
<br/>
https://t.co/MRAAetSHSJ</span>
</p>
<p>
<span class="medias">
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
</p>
++++