:jbake-type: post
:jbake-status: published
:jbake-title: Devoxxfr - du rÃ©actif au service du pneu connectÃ©
:jbake-tags: devoxx,kafka,reactive,vertx,_mois_avr.,_annÃ©e_2019
:jbake-date: 2019-04-19
:jbake-depth: ../../../../
:jbake-uri: wordpress/2019/04/19/devoxxfr-du-reactif-au-service-du-pneu-connecte.adoc
:jbake-excerpt: 
:jbake-source: https://riduidel.wordpress.com/2019/04/19/devoxxfr-du-reactif-au-service-du-pneu-connecte/
:jbake-style: wordpress

++++
<p>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/idriss_neumann" class="screenName"><img src="http://pbs.twimg.com/profile_images/1297261824371556352/9yMdakwV_mini.jpg" alt="profile of IoT, SRE, DevOps and Î¼services addict w/ docker, k8s, kafka, elasticstack, redis, python and vert.x. On Linux since 2000. https://t.co/oO8rew0Wy4, https://t.co/IOP8YBASPN, https://t.co/bhdkfzmNnG"/>idriss_neumann</a>
<br/>
<span class="name">Idriss Neumann âˆ ğŸ§ ğŸ³ â˜¸ï¸</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/idriss_neumann/status/1Â 118Â 799Â 928Â 409Â 636Â 864" class="date">18 avr. 2019 Ã  10:54:23</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">From reactive to to connected tire service with @vertx_project and @apachekafka at @DevoxxFR by @jponge and @FabienPomerol #Microservices https://t.co/6gZZtuoHLI</span>
</p>
<p>
<span class="medias">
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/D4bGk9wW4AAp_Di.jpg" alt="1Â 118Â 799Â 895Â 803Â 125Â 760"/>
<br/>
</span>
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/D4bGlk8XsAA4W1Y.jpg" alt="1Â 118Â 799Â 906Â 322Â 493Â 440"/>
<br/>
</span>
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/D4bGmAUWkAASHTO.jpg" alt="1Â 118Â 799Â 913Â 670Â 840Â 320"/>
<br/>
</span>
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/D4bGmfTW0AE16BO.jpg" alt="1Â 118Â 799Â 921Â 988Â 161Â 537"/>
<br/>
</span>
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
<br/>
<div id="preamble">
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-3">
</p>
<p>
<a href="https://twitter.com/jponge">Julien</a> travaille chez RedHat et Fabien, lui est chez Michelin et travaille sur un projet dâ€™ingestion des donnÃ©es dâ€™IoT. Parce que chez Michelin, ils ont des pneus connectÃ©s via du RFID pour
</p>
<p>
</div>
<br/>
<div class="olist arabic data-line-6">
<br/>
<ol class="arabic">
<br/>
<li>Identifier les pneus</li>
<br/>
<li>RÃ©cupÃ©rer les infos des capteurs de pression des pneus</li>
<br/>
</ol>
<br/>
</div>
<br/>
<div class="paragraph data-line-9">
</p>
<p>
Donc Michelin peut associer Ã  un pneu un historique de tempÃ©rature/pression. Ca se collecte via des outils embarquÃ©s (le tableau de bord) ou des smartphones. Et du coup, Ã§a paraÃ®t bien de rÃ©cupÃ©rer ces donnÃ©es pour gÃ©nÃ©rer des insights sur les flottes de pneus. Dans les use cases, on trouve
</p>
<p>
</div>
<br/>
<div class="ulist data-line-13">
<br/>
<ul>
<br/>
<li>le fleet management</li>
<br/>
<li>la prÃ©diction de fin de vie des pneus</li>
<br/>
<li>la gestion de la sÃ©curitÃ© (vÃ©rifier que la pression nâ€™est pas trop faible)</li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="paragraph data-line-17">
</p>
<p>
Des pneus, il y en a plein
</p>
<p>
</div>
<br/>
<div class="ulist data-line-19">
<br/>
<ul>
<br/>
<li>23 M de pneus</li>
<br/>
<li>1 Milliard d'Ã©vÃ©nements
<br/>
<div class="ulist data-line-21">
<br/>
<ul>
<br/>
<li>Donc 500 req/s</li>
<br/>
</ul>
<br/>
</div></li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="paragraph data-line-23">
</p>
<p>
Ã‰videment, ils essayent de consommer le moins d'Ã©nergie possible
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-25">
</p>
<p>
Avant, ils avaient une plateforme monolithique (en Grails - cool) avec un stockage MySQL. Ã‰videment, Ã§a ne tenait pas la charge.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-28">
</p>
<p>
Ils ont donc rÃ©Ã©crit Ã§a en micro-services â€¦â€‹ Ã©crits avec Vert.x ! Ces services communiquent via Kafka, et Ã©crivent leurs donnÃ©es dans MySQL/Neo4J/â€¦â€‹
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-31">
<br/>
<h2 id="truepourquoi_vert_x">Pourquoi Vert.x ?</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-33">
</p>
<p>
Le mode d'Ã©criture classique des applications utilise des I/O bloquants. Ca ne scale pas bien comme le montre Michelin. Et câ€™est dâ€™autant plus utile dans le monde des conteneurs (oÃ¹ il faut essayer dâ€™optimiser lâ€™usage des ressources).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-36">
</p>
<p>
Pour amÃ©liorer Ã§a, la solution est effectivement de faire de la boucle d'Ã©vÃ©nement et de la traiter de faÃ§on asynchrone. Avec un systÃ¨me rÃ©actif, on est
</p>
<p>
</div>
<br/>
<div class="ulist data-line-38">
<br/>
<ul>
<br/>
<li>Ã©lastique (on peut ajouter des noeuds)</li>
<br/>
<li>rÃ©silient (on peut tenir compte des pannes)</li>
<br/>
<li>responsive (au sens oÃ¹ les temps de rÃ©ponse restent raisonnables)</li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="paragraph data-line-42">
</p>
<p>
Lâ€™intÃ©rÃªt de vert.X est de sâ€™adapter facilement Ã  diffÃ©rents cas.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-44">
<br/>
<h2 id="trueingestion_de_donn_es">Ingestion de donnÃ©es</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-46">
</p>
<p>
Premier live-coding : Julien crÃ©e un verticle qui va rÃ©pondre donner via HTTP, la marque du pneu quand on donne son id. Pour Ã§a, il faut
</p>
<p>
</div>
<br/>
<div class="ulist data-line-49">
<br/>
<ul>
<br/>
<li>Un serveur HTTP (qui Ã©coute sur le port de notre choix)</li>
<br/>
<li>Un routeur</li>
<br/>
<li>Et Ã©videment une mÃ©thode qui retourne le rÃ©sultat quand on fait la requÃªte</li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="paragraph data-line-53">
</p>
<p>
Câ€™est facile Ã  Ã©crire (je le sais, jâ€™ai dÃ©jÃ  fait la mÃªme chose) et Julien lance le verticle avec gradle (qui fournit comme Maven du live-reload).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-55">
</p>
<p>
En vrai, câ€™est un peu plus compliquÃ© :
</p>
<p>
</div>
<br/>
<div class="ulist data-line-57">
<br/>
<ul>
<br/>
<li>Il y a trois routes HTTP</li>
<br/>
<li>Les donnÃ©es sont stockÃ©es dans MongoDB grÃ¢ce au client rÃ©actif fourni par Vert.x</li>
<br/>
</ul>
<br/>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-60">
<br/>
<h2 id="trueaggr_gation_de_services">AgrÃ©gation de services</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-62">
</p>
<p>
Il faut parfois faire plusieurs requÃªtes asynchrones et assembler les rÃ©sultats. On peut faire des callbacks, mais câ€™est assez complexe. Dans Vert.x, on a
</p>
<p>
</div>
<br/>
<div class="ulist data-line-66">
<br/>
<ul>
<br/>
<li>Des futures</li>
<br/>
<li>Des coroutines Kotlin ou Java (avec Quasar)</li>
<br/>
<li>Ou du RxJava que supporte trÃ¨s bien Vert.x</li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="paragraph data-line-70">
</p>
<p>
On passe donc Ã  une deuxiÃ¨me dÃ©mo oÃ¹ Julien va faire du machine learning (autrement dit de la rÃ©gression linÃ©aire) pour savoir si le pneu perd en pression. On a donc deux services en amont
</p>
<p>
</div>
<br/>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/idriss_neumann" class="screenName"><img src="http://pbs.twimg.com/profile_images/1297261824371556352/9yMdakwV_mini.jpg" alt="profile of IoT, SRE, DevOps and Î¼services addict w/ docker, k8s, kafka, elasticstack, redis, python and vert.x. On Linux since 2000. https://t.co/oO8rew0Wy4, https://t.co/IOP8YBASPN, https://t.co/bhdkfzmNnG"/>idriss_neumann</a>
<br/>
<span class="name">Idriss Neumann âˆ ğŸ§ ğŸ³ â˜¸ï¸</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/idriss_neumann/status/1Â 118Â 805Â 700Â 828Â 962Â 816" class="date">18 avr. 2019 Ã  11:17:20</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">@Michelin is using @vertx_project #microservices with @apachekafka to anticipate and alert the connected tires defects #IoT. Demo by @jponge and @FabienPomerol at @DevoxxFR https://t.co/bmSXzfQh2c</span>
</p>
<p>
<span class="medias">
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/D4bL1wOWsAA4rlt.jpg" alt="1Â 118Â 805Â 681Â 786Â 761Â 216"/>
<br/>
</span>
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/D4bL2IcWwAAM2Ze.jpg" alt="1Â 118Â 805Â 688Â 287Â 936Â 512"/>
<br/>
</span>
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/D4bL2dgX4AEsVqk.jpg" alt="1Â 118Â 805Â 693Â 941Â 932Â 033"/>
<br/>
</span>
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
<br/>
<div class="ulist data-line-73">
<br/>
<ul>
<br/>
<li>le service donnant le nom du pneu</li>
<br/>
<li>un service faisant cette rÃ©gression linÃ©aire</li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="paragraph data-line-76">
</p>
<p>
Et pour les combiner, on appelle un <code>Single</code> RxJava. Ã‰videment, on peut aussi produire ce <code>Single</code> Ã  partir dâ€™une requÃªte en appelant <code>.rxSend()</code> qui va envoyer la requÃªte et lâ€™encapsuler dans un objet RxJava. Dans les bonus, RxJava fournit par exemple la gestion de la qualitÃ© de service en tentant de rappeler plusieurs fois le service (ou aussi une bonne gestion des timeout).
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-78">
<br/>
<h2 id="trueevent_driven_microservices">Event driven microservices</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-80">
</p>
<p>
Ã‰videment, il est aussi possible de rÃ©cupÃ©rer des donnÃ©es autrement quâ€™en HTTP. Par exemple, pour construire des alertes sur la pression des pneus, Michelin dÃ©veloppe des services qui vont lire dans un topic Kafka pour Ã©crire dans un autre topic â€¦â€‹ qui sera utilisÃ© par le service dâ€™alerte de pression de pneus.
</p>
<p>
</div>
<br/>
<div class="sect2 data-line-83">
<br/>
<h3 id="truedashboard">Dashboard</h3>
<br/>
<div class="paragraph data-line-85">
</p>
<p>
Le dashboard va afficher les pressions des pneus avec les pneus qui ont une mauvaise pression. Pour simuler le systÃ¨me Michelin, Julien va utiliser Locust - un outil de charge en Python pour injecter des donnÃ©es.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-88">
</p>
<p>
Donc le dashboard a plusieurs consomateurs Kafka :
</p>
<p>
</div>
<br/>
<div class="ulist data-line-90">
<br/>
<ul>
<br/>
<li>Un premier pour les mesures dâ€™ingestion qui pousse les mesures vers le bus d'Ã©vÃ©nement de Vert.x (celui-ci peu envoyer les Ã©vÃ©nements vers dâ€™autres Vert.x, ou mÃªme vers le navigateur)</li>
<br/>
<li>Un autre pour la perte de pression</li>
<br/>
</ul>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-93">
<br/>
<h3 id="trueingestion">Ingestion</h3>
<br/>
<div class="paragraph data-line-95">
</p>
<p>
On a juste remplacÃ© lâ€™ingestion dans MongoDB par une ingestion dans Kafka
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-97">
<br/>
<h3 id="truealerte">Alerte</h3>
<br/>
<div class="paragraph data-line-99">
</p>
<p>
Ici, on Ã©coute sur un topic Kafka pour pousser dans un autre topic Kafka. Donc, dans ce topic, grÃ¢ce Ã  RxJava, on va grouper les Ã©vÃ©nements de pression par id de pneu puis faire une rÃ©gression linÃ©aire sur ces pressions pour pousser les rÃ©sultats dans un autre topic.
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-102">
<br/>
<h3 id="trueinterface_web">Interface web</h3>
<br/>
<div class="paragraph data-line-104">
</p>
<p>
Pour produire lâ€™interface web, on va simplement connecter le navigateur Ã  lâ€™event bus pour rÃ©cupÃ©rer les Ã©vÃ©nements. On peut aussi envoyer des Ã©vÃ©nements depuis le navigateur dans le bus d'Ã©vÃ©nements
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/paulp_si" class="screenName"><img src="http://pbs.twimg.com/profile_images/1234809694344110080/PQ_sUos7_mini.jpg" alt="profile of #Zz, PassionnÃ© par la tech et lâ€™entrepreneuriat avec un goÃ»t prononcÃ© pour lâ€™#IoT et les #Humains - aka https://t.co/csrnuqYKoH - membre de @volcampIO"/>paulp_si</a>
<br/>
<span class="name">paulp</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/paulp_si/status/1Â 118Â 805Â 546Â 784Â 710Â 656" class="date">18 avr. 2019 Ã  11:16:43</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">Demo de suivi de pression de pneumatiques et emission dâ€™alertes Ã  #DevoxxFr utilisant @vertx_project et #kafka https://t.co/JkWdxD0EAI</span>
</p>
<p>
<span class="medias">
<br/>
<span class="media media-video">
<br/>
Media at <a href="http://pbs.twimg.com/ext_tw_video_thumb/1118805515444858880/pu/img/lRR9M2FK-qlGFZ3B.jpg">http://pbs.twimg.com/ext_tw_video_thumb/1118805515444858880/pu/img/lRR9M2FK-qlGFZ3B.jpg</a>
<br/>
</span>
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
<br/>
<div class="sect1 data-line-107">
<br/>
<h2 id="trueconclusion">Conclusion</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-109">
</p>
<p>
Dans l'Ã©quipe de dÃ©v, composÃ©e dâ€™une 15aine de personnes plutÃ´t junior, le passage Ã  lâ€™asynchrone nâ€™a pas Ã©tÃ© trÃ¨s simple. Sans doute parce que Vert.x est un toolkit plutÃ´t quâ€™un framework. L'Ã©quipe a Ã©tÃ© tentÃ©e de construire une cathÃ©drale (autrement dit un framework).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-112">
</p>
<p>
Lâ€™event bus est aussi un point important : ce bus nâ€™est pas durable, et il nâ€™y a pas de gestion de la back pressure. Ca en fait un mauvais candidat pour communiquer entre micro-services. Il vaut donc mieux passer par un bus externe (comme Kafka ou RabbitMQ). Parce que Ã§a nâ€™est <strong>pas</strong> un bus de messaging.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-115">
</p>
<p>
Rentrer dans le monde des micro-services, câ€™est rentrer dans un nouveau monde empli de problÃ¨mes spÃ©cifiques :
</p>
<p>
</div>
<br/>
<div class="ulist data-line-117">
<br/>
<ul>
<br/>
<li>lâ€™idempotence</li>
<br/>
<li>lâ€™exactly once delivery</li>
<br/>
<li>le tracing</li>
<br/>
<li>la synchronisation</li>
<br/>
<li>la (dÃ©)normalisation</li>
<br/>
<li>le cache distribuÃ©</li>
<br/>
<li>la concurrence</li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="paragraph data-line-125">
</p>
<p>
Attention Ã©galement : il faut monitorer et tracer les appels. Câ€™est important parce quâ€™il y a toujours plusieurs instances dâ€™un micro-service, et quâ€™il faut savoir quelle instance a traitÃ© quel message.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-128">
</p>
<p>
Dâ€™un point de vue personnel, pour avoir dÃ©jÃ  beaucoup jouÃ© avec Vert.x, je nâ€™ai pas appris grand chose â€¦â€‹ sauf sur la partie rÃ©active. Par contre, la prÃ©sentation Ã©tait trÃ¨s chouette, et la discussion avec Julien et Fabien sur l'ASM (le club de rugby, hein), Golo, et d'autres sujets Ã©tait trÃ¨s chouette !
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
</p>
<p>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/jponge" class="screenName"><img src="http://pbs.twimg.com/profile_images/1350099660074061824/RgNOhHrg_mini.jpg" alt="profile of ğŸ’¡ Reactive @RedHat ğŸ“– Vert.x in Action @ManningBooks â¡ï¸ Personal account, tweets do not reflect the views of my employers"/>jponge</a>
<br/>
<span class="name">Julien Ponge</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/jponge/status/1Â 118Â 794Â 563Â 676Â 717Â 057" class="date">18 avr. 2019 Ã  10:33:04</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">Full room it might be ğŸ˜‡ https://t.co/IxsPKKPdiZ</span>
</p>
<p>
<span class="medias">
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/D4bBuMUW0AILeaI.jpg" alt="1Â 118Â 794Â 556Â 772Â 896Â 770"/>
<br/>
</span>
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
</p>
++++