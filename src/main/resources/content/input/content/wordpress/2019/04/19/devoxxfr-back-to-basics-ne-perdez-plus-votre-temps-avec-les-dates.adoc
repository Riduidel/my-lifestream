:jbake-type: post
:jbake-status: published
:jbake-title: Devoxxfr - Back to basics, ne perdez plus votre temps avec les dates
:jbake-tags: date,devoxx,_mois_avr.,_annÃ©e_2019
:jbake-date: 2019-04-19
:jbake-depth: ../../../../
:jbake-uri: wordpress/2019/04/19/devoxxfr-back-to-basics-ne-perdez-plus-votre-temps-avec-les-dates.adoc
:jbake-excerpt: 
:jbake-source: https://riduidel.wordpress.com/2019/04/19/devoxxfr-back-to-basics-ne-perdez-plus-votre-temps-avec-les-dates/
:jbake-style: wordpress

++++
<p>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/zepag" class="screenName"><img src="http://pbs.twimg.com/profile_images/1327603069643878402/2BX0Zz9E_mini.jpg" alt="profile of Geek, photography enthusiast, Open Source and Devops fan, organizer of  @devops_lu, @YaJUG and @voxxed_lu conference"/>zepag</a>
<br/>
<span class="name">Pierre-Antoine GrÃ©goire ğŸŒŠğŸ§ğŸ‡«ğŸ‡·ğŸ“·ğŸ¸ğŸ®</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/zepag/status/1Â 118Â 839Â 192Â 992Â 321Â 536" class="date">18 avr. 2019 Ã  13:30:25</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">Je sens que @fcamblor va faire des calembours douteux sur les dates :D intro sur fond des horloges d'Emmet Brown :) #DevoxxFR https://t.co/mwaLRHVfym</span>
</p>
<p>
<span class="medias">
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/D4bqSFhWsAAyF7d.jpg" alt="1Â 118Â 839Â 153Â 888Â 768Â 000"/>
<br/>
</span>
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
<br/>
<div id="preamble">
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-3">
</p>
<p>
Les problÃ¨mes de date, Ã§a arrive Ã  tout le monde : Microsoft, Apple, Twitter. Donc Ã§a vous est arrivÃ© â€¦â€‹ ou Ã§a va vous arriver.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-5">
<br/>
<h2 id="trueavant">Avant</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-7">
</p>
<p>
Au dÃ©but, on utilisait le soleil pour mesurer le temps. Ca permettait juste de savoir le milieu de la journÃ©e. Et pour des villes qui sont sur le mÃªme fuseau horaire, lâ€™heure solaire (lâ€™heure vraie) peut Ãªtre diffÃ©rente. Pour Ã©viter Ã§a, on utilise une heure standard. La premiÃ¨re Ã©tait GMT (maintenant dÃ©prÃ©ciÃ©e en faveur dâ€™UTC).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-11">
</p>
<p>
Le temps repose sur la seconde, une unitÃ© dans laquelle on a confiance, puisquâ€™elle est dÃ©finie par un Ã©lÃ©ment physique rÃ©gulier et mesurable. Aujourdâ€™hui, câ€™est dÃ©fini par un nombre donnÃ© dâ€™oscillations de lâ€™atome de cÃ©sium. Câ€™est le temps atomique international. Ce temps sert de base au temps UTC. Il est stable quelquesoit la saison et dÃ©marre Ã  <a href="https://fr.wikipedia.org/wiki/Epoch">EPOCH</a>. Comme la rotation de la Terre nâ€™est pas forcÃ©ment constante, on introduit rÃ©guliÃ¨rement des leap seconds. Depuis EPOCH, on en a introduit 37.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-13">
</p>
<p>
Le temps est envoyÃ© aux ordinateurs depuis des horloges atomiques Ã  travers le protocole <a href="https://fr.wikipedia.org/wiki/Network_Time_Protocol">NTP</a>. Si il y a des deltas entre le client et le serveur, NTP garantit que les Ã©changes mettent toujours moins de 1 seconde.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-15">
<br/>
<h2 id="truerepr_senter_le_temps">ReprÃ©senter le temps</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-17">
</p>
<p>
Pour reprÃ©senter le temps, on peut utiliser des timestamps. Evidement, ces timestamps sâ€™expriment sur un nombre de bit donnÃ© â€¦â€‹ qui sera rempli Ã  EPOCHalypse. Du coup, Ã§a a un impact sur le stockage des dates reprÃ©sentant des instants dans le futur.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-19">
</p>
<p>
On peut aussi utiliser les datetimes ISO (8601). Qui incluent la date, lâ€™heure, et le fuseau horaire.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-21">
</p>
<p>
Enfin, on peut utiliser des dates et heures locaux (sans fuseau horaire). Clairement, il y a beaucoup de non-dits dans ces cas, ce qui nâ€™aide vraiment pas. On peut Ã©galement dissocier des dates &#38; heures.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-23">
<br/>
<h2 id="trueles_timezones">Les timezones</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-25">
</p>
<p>
Une timezone, câ€™est un fuseau horaire. Et un timezone offset, câ€™est le dÃ©calage entre un fuseau horaire et UTC. Attention : Ã  partir dâ€™une timezone, on ne peut pas forcÃ©ment dÃ©terminer le timezone offset (par exemple, en France, on a une heure d'Ã©tÃ©/heure dâ€™hiver).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-28">
</p>
<p>
La plupart des timezone dÃ©finissent des offsets entiers par rapport Ã  UTC. Ces offsets sont variables par timezone. Et on utilise des TZ Table pour les dÃ©terminer.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-30">
</p>
<p>
Les TZ Table sont disponibles sur GitHub, sur un repository oÃ¹ il y a des changements â€¦â€‹ plusieurs fois par semaine.
</p>
<p>
</div>
<br/>
<div class="sect2 data-line-32">
<br/>
<h3 id="truecomment_le_syst_me_se_met_il_jour">Comment le systÃ¨me se met-il Ã  jour ?</h3>
<br/>
<div class="ulist data-line-34">
<br/>
<ul>
<br/>
<li>En Java, les TZ Data sont dÃ©finies dans le JRE (et peuvent Ãªtre updatÃ©es par le TZUpdater - disponible dans le JDK).</li>
<br/>
<li>Pour MySQL, il faut le faire Ã  la main.</li>
<br/>
<li>En Node, on le fait Ã  la main avec un paquet mis Ã  jour Ã  chaque release des TZ Data</li>
<br/>
</ul>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-39">
<br/>
<h3 id="trueque_faire">Que faire ?</h3>
<br/>
<div class="paragraph data-line-40">
</p>
<p>
Ca dÃ©pend des applications : une application purement franÃ§aise pourra survivre Ã  des mises Ã  jour peu frÃ©quentes. Par contre, pour lâ€™international, il faut pouvoir suivre ces mises Ã  jour rapidement (les russes ont changÃ© leurs TZ Data avec une action effective un mois aprÃ¨s).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-42">
</p>
<p>
En particulier, crÃ©er des dates dans le futur est dangereux, puisque les rÃ¨gles peuvent changer. Si vous devez le faire, stockez la date et lâ€™heure locale ainsi que la timezone de lâ€™utilisateur (et la date de crÃ©ation).
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-45">
<br/>
<h2 id="truedst">DST</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-47">
</p>
<p>
Le changement dâ€™heure, Ã§a nâ€™est pas pratique (et Ã§a risque de disparaÃ®tre).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-49">
</p>
<p>
Mais il y a autre chose : quand on passe de lâ€™heure dâ€™hiver Ã  lâ€™heure dâ€™Ã©tÃ©, une heure nâ€™existe pas. Ca a un impact : que fait votre librairie quand vous donnez une heure qui nâ€™existe pas ? Avec java.util.Date, Ã§a plante.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-52">
</p>
<p>
RÃ©ciproquement, au passage Ã  lâ€™heure dâ€™hiver, une heure existe deux fois. Ca nâ€™est pas non plus trÃ¨s pratique. Dans ce cas, le comportement peut aussi Ãªtre diffÃ©rent selon le navigateur.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-54">
</p>
<p>
Dans les grosses boÃ®tes, les batches qui passent la nuit (Ã  2H30, par exemple) peuvent avoir des problÃ¨mes pÃ©nibles. Pour Ã©viter Ã§a, il faut baser les batches sur des heures UTC.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-56">
<br/>
<h2 id="truecas_particuliers">Cas particuliers</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-58">
</p>
<p>
En plus de ces Ã©lÃ©ments â€¦â€‹ curieux, il y a tout un tas de cas particuliers :
</p>
<p>
</div>
<br/>
<div class="ulist data-line-60">
<br/>
<ul>
<br/>
<li>Les annÃ©es bissextiles</li>
<br/>
<li>Le 31 dÃ©cembre dâ€™une annÃ©e aux Ã®les Samoa nâ€™existe pas</li>
<br/>
<li>Deux dates Java sont Ã©gales si elles utilisent le mÃªme fuseau horaire. Si Ã§a nâ€™est pas le cas, il ya une mÃ©thode <code>isEqual</code> pour Ã§a</li>
<br/>
<li>Et encore, Ã§a nâ€™est rien Ã  cÃ´tÃ© de la gestion des dates en Javascript, qui semble Ãªtre authentiquement la fÃªte de la saucisse</li>
<br/>
</ul>
<br/>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-65">
<br/>
<h2 id="truequelques_bonnes_pratiques">Quelques bonnes pratiques</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="ulist data-line-67">
<br/>
<ul>
<br/>
<li>Tous les serveurs doivent Ãªtre en timezone UTC Ã  tous les niveaux
<br/>
<div class="ulist data-line-68">
<br/>
<ul>
<br/>
<li>La timezone de lâ€™OS doit Ãªtre UTC</li>
<br/>
<li>La timezone de la DB doit Ãªtre UTC</li>
<br/>
</ul>
<br/>
</div></li>
<br/>
<li>Envoyer la date nâ€™est pas trivial
<br/>
<div class="ulist data-line-71">
<br/>
<ul>
<br/>
<li>Nâ€™envoyez pas de date sans fuseau horaire</li>
<br/>
<li>Nâ€™envoyez pas non plus de date simplement avec la date</li>
<br/>
<li>Envoyez plutÃ´t une range de date (avec la timezone) pour Ã©viter les problÃ¨mes louches de changement dâ€™heure</li>
<br/>
</ul>
<br/>
</div></li>
<br/>
<li>En vrai, les recherches de date sont en gÃ©nÃ©ral des recherches de range â€¦â€‹ Ca mÃ©rite dâ€™y rÃ©flÃ©chir</li>
<br/>
<li>Nâ€™utilisez pas de LocalDateTime !</li>
<br/>
</ul>
<br/>
</div>
<br/>
<div class="sect2 data-line-77">
<br/>
<h3 id="truetime_only_patterns">Time-only patterns</h3>
<br/>
<div class="ulist data-line-79">
<br/>
<ul>
<br/>
<li>Stocker toujours la timezone de lâ€™utilisateur ayant saisi lâ€™heure</li>
<br/>
<li>Evitez de stocker votre heure dans un objet DateTime
<br/>
<div class="ulist data-line-81">
<br/>
<ul>
<br/>
<li>Utilisez plutÃ´t une chaÃ®ne de caractÃ¨re avec la timezone Ã  cÃ´tÃ©</li>
<br/>
</ul>
<br/>
</div></li>
<br/>
</ul>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-83">
<br/>
<h3 id="truedate_only_patterns">Date-only patterns</h3>
<br/>
<div class="ulist data-line-85">
<br/>
<ul>
<br/>
<li>Utilisez une structure adaptÃ©e</li>
<br/>
<li>Evitez de stocker une date dans une DateTime. Si vous devez le faire, utilisez midi comme heure, câ€™est plus facile.</li>
<br/>
<li>Si vous connaissez la timezone, stockez-la</li>
<br/>
</ul>
<br/>
<h2>Conclusion</h2>
<br/>
C'Ã©tait aussi intÃ©ressant que ce Ã  quoi je m'attendais, et Ã  mon avis un super complÃ©ment Ã  l'Ã©norme article de <a href="https://codeblog.jonskeet.uk/2019/03/27/storing-utc-is-not-a-silver-bullet/">Jon Skeet</a> sur le mÃªme sujet. Et en plus, <a href="https://twitter.com/fcamblor">FrÃ©dÃ©ric</a> Ã©tait vraiment bon.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
</div>
</p>
++++