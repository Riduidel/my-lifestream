:jbake-type: post
:jbake-status: published
:jbake-title: Devoxxfr - Les multiples facettes du logging dans les conteneurs Docker
:jbake-tags: devoxx,docker,logs,_mois_avr.,_annÃ©e_2019
:jbake-date: 2019-04-19
:jbake-depth: ../../../../
:jbake-uri: wordpress/2019/04/19/devoxxfr-les-multiples-facettes-du-logging-dans-les-conteneurs-docker.adoc
:jbake-excerpt: 
:jbake-source: https://riduidel.wordpress.com/2019/04/19/devoxxfr-les-multiples-facettes-du-logging-dans-les-conteneurs-docker/
:jbake-style: wordpress

++++
<p>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/m_gandin" class="screenName"><img src="http://pbs.twimg.com/profile_images/776485864151154688/chv_ri-A_mini.jpg" alt="profile of I program my home computer / Beam myself into the future (and mostly writing code at https://t.co/Is2qla9X88)"/>m_gandin</a>
<br/>
<span class="name">Mathieu Gandin</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/m_gandin/status/1Â 118Â 916Â 999Â 789Â 318Â 144" class="date">18 avr. 2019 Ã  18:39:35</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">Tools in Action sur le logging dans les conteneurs Docker par @nicolas_frankel #DevoxxFR https://t.co/gWFj7DYYUA</span>
</p>
<p>
<span class="medias">
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/D4cxEsJWkAADdfy.jpg" alt="1Â 118Â 916Â 989Â 064Â 482Â 816"/>
<br/>
</span>
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
</p>
<p>
<div class="paragraph data-line-3">
</p>
<p>
Pour me finir la journÃ©e, quoi de mieux que d'Ã©couter <a href="https://twitter.com/nicolas_frankel/">Nicolas</a> me parler de logs ?
</p>
<p>
Quand on fait du Docker, on produit des logs. Cool. On peut bien sÃ»r sâ€™attacher aux conteneurs pour voir leurs logs. Mais comme pour se dÃ©tacher, on fait <code>Ctrl-C</code>, le conteneur sâ€™arrÃªte. Et du coup câ€™est pas pratique. En fait, quand on sâ€™attache Ã  un conteneur, tous les signaux sont transmis Ã  ce conteneur (y compris le <code>Ctrl-C</code> qui l'arrÃªte). Pour Ã©viter Ã§a, il y a lâ€™option <code>--sig-proxy=false</code>.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-7">
</p>
<p>
Ã‰videment, quand on fait <code>docker logs</code>, on a tous les logs du conteneur. Illisible.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-9">
</p>
<p>
Pour rÃ©cupÃ©rer directement, le fichier, on peut faire un petit <code>docker inspect â€¦â€‹</code> qui nous donnera, cachÃ© dans un coin, le <code>LogPath</code>. Et ce fichier de log, si vous Ãªtes sous linux, contiendra les logs Docker en JSON.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-11">
</p>
<p>
Pour Ã©viter ces couches dâ€™abstraction, utilisons donc â€¦â€‹ le cloud ! (en lâ€™occurrence <a href="https://www.exoscale.com/">Exoscale</a>, puisque Nicolas bosse pour eux). Donc Nicolas redÃ©marre son conteneur sur une machine hÃ©bergÃ©e chez Exoscale, et refait la mÃªme manÅ“uvre de <code>docker logs</code>, <code>docker inspect</code>. Mais dans le cloud, les logs centralisÃ©s, câ€™est quand mÃªme mieux, non ? Donc autant prendre les logs et les pousser dans <a href="https://www.elastic.co/fr/products/elasticsearch">ElasticSearch</a> avec <a href="https://www.elastic.co/products/beats/filebeat">FileBeat</a>. Ce qui est galÃ¨re, câ€™est quand mÃªme dâ€™aller chercher lâ€™emplacement du fichier. En plus, filebeat est normalement capable de retrouver le fichier de logs. Pour Ã§a, il suffit de donner Ã  filebeat lâ€™id du conteneur Docker. En faisant Ã§a, filebeat retrouve donc le fichier, et rÃ©cupÃ¨re le vrai message de log (et pas le JSON produit par Docker).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-19">
</p>
<p>
Par contre, Ã©videment, les logs vont grossir, et il va falloir faire de la log rotation et autres saletÃ©s dâ€™admin sys. On peut donc utiliser un driver de logs diffÃ©rents pour notre conteneur, pour envoyer par exemple les logs avec gelf. Ã‰videment, pour consommer les logs, il faut un logstash. Et en plus, <code>docker logs</code> ne marche plus.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-24">
</p>
<p>
Et puis franchement, des applications qui Ã©crivent sur stdout â€¦â€‹ il y en a peu. Par exemple, Tomcat Ã©crit dans trois fichiers (et pas dans stdout). Nicolas prend donc un conteneur qui Ã©crit ses logs dans des fichiers â€¦â€‹
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-27">
</p>
<p>
On peut bien sÃ»r monter ce fichier de log via un volume sur le host. Mais câ€™est assez embÃªtant parce que Ã§a supprime lâ€™abstraction quâ€™offre Docker. Pour Ã§a, filebeats peut accÃ©der aux volumes exposÃ©s par notre conteneur qui produit des logs grÃ¢ce Ã  un volume partagÃ©.
<br/>
<h2>Conclusion</h2>
<br/>
Â 
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-30">
</p>
<p>
A travers ses diffÃ©rentes dÃ©mos, Nicolas nous a donc montrÃ© que
</p>
<p>
</div>
<br/>
<div class="ulist data-line-32">
<br/>
<ul>
<br/>
<li>Il ne faut pas utiliser attach</li>
<br/>
<li>Si vous voulez rÃ©cupÃ©rer vos logs, vous risquez de perdre <code>docker logs</code>.</li>
<br/>
<li>Il vous faut un outil de gestion de logs centralisÃ©.</li>
<br/>
</ul>
<br/>
MÃªme si le sujet ne semble pas foufou, l'analyse de logs, c'est un truc qui occupe pas mal de mon temps, et ce que montrait Nicolas Ã©tait chouette (et je dis pas Ã§a parce qu'on aÂ  tous les deux le mÃªme prÃ©nom, le mÃªme humour, le mÃªme genre de voix discrÃ¨te, bref, beaucoup trop de points communs)
</p>
<p>
</div>
</p>
<p>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/nicolas_frankel" class="screenName"><img src="http://pbs.twimg.com/profile_images/1063110424306929664/9pYrPAp6_mini.jpg" alt="profile of ğŸ¥‘ Developer Advocate @Hazelcast
<br/>
âœï¸ Blogger at https://t.co/nnBYBMZOCC
<br/>
ğŸ“ Learner
<br/>
ğŸ§‘â€ğŸ’» Former developer and architect
<br/>
ğŸ“– Author of https://t.co/p1nP5PIUmo"/>nicolas_frankel</a>
<br/>
<span class="name">Nicolas Frankel (@Home for a long time I believe)</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/nicolas_frankel/status/1Â 119Â 008Â 297Â 347Â 104Â 768" class="date">19 avr. 2019 Ã  00:42:22</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">Merci Ã  tous les participants Ã  la session "Les multiples facettes du #logging dans un container #Docker" Ã  #DevoxxFR. Les slides sont maintenant disponibles https://t.co/2SSj8fRwlp</span>
</p>
<p>
<span class="medias">
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
</p>
++++