:jbake-type: post
:jbake-status: published
:jbake-title: To be or not to be serverless
:jbake-tags: chtijug,cloud,serverless,_mois_mai,_ann√©e_2019
:jbake-date: 2019-05-24
:jbake-depth: ../../../../
:jbake-uri: wordpress/2019/05/24/to-be-or-not-to-be-serverless.adoc
:jbake-excerpt: 
:jbake-source: https://riduidel.wordpress.com/2019/05/24/to-be-or-not-to-be-serverless/
:jbake-style: wordpress

++++
<p>
<div id="preamble">
<br/>
<div class="sectionbody">
</p>
<p>
<div class='twitter'>
<br/>
<span class="twitter_status">
</p>
<p>
<span class="author">
</p>
<p>
<a href="http://twitter.com/chtijug" class="screenName"><img src="http://pbs.twimg.com/profile_images/1179656487326617600/2uFfDuut_mini.jpg" alt="profile of Le Java User Group des Ch'tis d'un Ch'nord"/>chtijug</a>
<br/>
<span class="name">Ch'ti JUG</span>
</p>
<p>
</span>
</p>
<p>
<a href="https://twitter.com/chtijug/status/1¬†131¬†617¬†057¬†823¬†436¬†806" class="date">23 mai 2019 √† 19:45:05</a>
</p>
<p>
<span class="content">
</p>
<p>
<span class="text">Hello Serverless World üëã https://t.co/7HLU90d5T0</span>
</p>
<p>
<span class="medias">
<br/>
<span class="media media-photo">
<br/>
<img src="http://pbs.twimg.com/media/D7RPtVSX4AA-Mm7.jpg" alt="1¬†131¬†617¬†046¬†603¬†751¬†424"/>
<br/>
</span>
<br/>
</span>
</p>
<p>
</span>
</p>
<p>
<span class="twitter_status_end"/>
<br/>
</span>
<br/>
</div>
<br/>
<div class="paragraph data-line-3">
</p>
<p>
<a href="https://twitter.com/SteveHouel">Steve</a> va nous faire un tour d‚Äôhorizon du serverless, dans le cadre de son tour de France (qui continuera √† Lille le mois prochain).
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-5">
<br/>
<h2 id="truepr_sentation">Pr√©sentation</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="sect2 data-line-7">
<br/>
<h3 id="trueun_peu_d_histoire">Un peu d‚Äôhistoire</h3>
<br/>
<div class="paragraph data-line-8">
</p>
<p>
EN 2006, on a commenc√© √† remplacer la virtualisation par le cloud chez AWS (pour lequel Steve a un gros faible). Puis les conteneurs sont apparus et ont conquis le march√©, puisqu'aujourd‚Äôhui, tout le monde conna√Æt K8s. Puis le serverless est apparu aux environs de 2014.
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-12">
<br/>
<h3 id="truec_est_quoi">C‚Äôest quoi ?</h3>
<br/>
<div class="paragraph data-line-13">
</p>
<p>
En serverless, on ne g√®re pas les serveurs (√ßa ne veut pas dire qu‚Äôils n‚Äôexistent pas). En fait, on ne voit pas les serveurs (pas plus qu‚Äôon ne les g√®re). Si on veut distinguer, il y a
</p>
<p>
</div>
<br/>
<div class="ulist data-line-16">
<br/>
<ul>
<br/>
<li>BaaS : <strong>backend as a service</strong>. C‚Äôest le terme utilis√© pour les bases de donn√©es acc√©d√©s comme un service (<a href="https://www.mongodb.com/cloud/atlas">Mongo Atlas</a>, <a href="https://aiven.io/">Aiven</a>) ou des facilit√©s comme <a href="https://auth0.com/">Auth0</a>.</li>
<br/>
<li>FaaS : <strong>function as a service</strong>. C‚Äôest la partie √† laquelle on va plut√¥t s‚Äôint√©resser. On y d√©ploie des fonctions, pour lesquelles on ne g√®re pas le CPU/la RAM/l‚ÄôOS. Et √©videment, on paye √† la requ√™te.</li>
<br/>
</ul>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-19">
<br/>
<h3 id="truequ_est_ce_qui_n_est_pas_serverless">Qu‚Äôest-ce qui n‚Äôest pas serverless</h3>
<br/>
<div class="ulist data-line-21">
<br/>
<ul>
<br/>
<li>Evidement, le PaaS n‚Äôest pas serverless. Par exemple, Heroku n‚Äôest pas serverless. Parce que la granularit√© n‚Äôest pas la m√™me ‚Ä¶‚Äã et le sch√©ma de pricing n‚Äôest √©videment pas le m√™me.</li>
<br/>
<li>Les conteneurs ne sont pas du serverless. Parce qu‚Äôil va falloir g√©rer un orchestrateur.</li>
<br/>
<li>NoOps n‚Äôest pas non plus du serverless. Effectivement, il n‚Äôy a plus d‚ÄôOS √† g√©rer. Mais il faudra toujours garantir la s√©curit√©. Il faudra √©galement observer le syst√®me (ce qui devient beaucoup plus compliqu√© quand les composants se multiplient).</li>
<br/>
</ul>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-25">
<br/>
<h3 id="truequi_fait_du_serverless">Qui fait du serverless</h3>
<br/>
<div class="paragraph data-line-27">
</p>
<p>
AWS √©videment. Azure atteint presque le niveau. Il y a √©galement des outils bas√©s sur K8s (OpenFaas). OVH fournit aussi des OVH cloud functions. KNative, OpenWhisk, ‚Ä¶‚Äã sont aussi des fournisseurs, moins importants.
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-32">
<br/>
<h3 id="trueca_veut_dire_quoi">Ca veut dire quoi ?</h3>
<br/>
<div class="paragraph data-line-34">
</p>
<p>
Dans le mode classique, quand une application prend plus de CPU, on rajoute des machines en fonction des besoins. Mais sur chaque machine, on a surprovisionn√© pour se garder de la marge. Et bien s√ªr, √ßa co√ªte de l‚Äôargent.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-37">
</p>
<p>
Du coup, on passe √† la conteneurisation. Donc on ajoute des pods dans notre cluster. Mais il y a toujours un moment o√π on va devoir ajouter un nouveau worker K8s, ce qui est √† nouveau de la surprovision ‚Ä¶‚Äã Mais grosse (parce que le worker K8s est souvent plus costaud).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-42">
</p>
<p>
En serverless, chaque fonction (c‚Äôest-√†-dire chaque √©l√©ment de l‚Äôapplication) sera scal√© ind√©pendamment, isol√©, et d√©marr√© en fonction des demandes. Cette fonction sera aussi arr√™t√©e d√®s qu‚Äôelle n‚Äôest plus utilis√©e. L‚Äôint√©r√™t √©vident, c‚Äôest de s‚Äôadapter efficacement aux patterns d‚Äôutilisation de l‚Äôapplication.
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-46">
<br/>
<h3 id="truede_plus_haut">De plus haut</h3>
<br/>
<div class="paragraph data-line-48">
</p>
<p>
Dans une architecture serverless, il y aura un service externe qui √©met des √©v√©nements. La fonction r√©agit √† cet √©v√©nement en √©mettant d‚Äôautres √©v√©nements, ou aussi en stockant des donn√©es
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-51">
</p>
<p>
Un cas d‚Äôutilisation typique est celui de l‚Äôapplication web fortement utilis√©e de fa√ßon temporaire (comme par exemple les applis de vote de t√©l√©r√©alit√©) : les requ√™tes seront envoy√©es sur des fonctions qui vont √©crire dans Dynamo pour produire un dashboard accessible worldwide. Un autre cas courant est celui du traitement de fichier en masse : on envoie les fichiers dans S3, ces insertions cr√©ent des √©v√©nements qui sont trait√©s par des fonctions pour √©crire dans S3 ou Dynamo. L‚ÄôIoT est aussi un tr√®s bon cas d‚Äôusage, en particulier parce que la consommation de ressources va √©voluer rapidement dans le temps.
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-55">
<br/>
<h3 id="trueb_n_fices">B√©n√©fices</h3>
<br/>
<div class="paragraph data-line-57">
</p>
<p>
D‚Äôabord on r√©duit les co√ªts op√©rationnels. Pas parce qu‚Äôon a supprim√© les ops, mais parce qu‚Äôon a limit√© la charge d‚Äôop√©ration (en enlevant la gestion des machines). On r√©duit aussi le co√ªt d‚Äôutilisation des BaaS (justement parce que ce sont les fournisseurs de ces backends qui en assurent le fonctionnement). Par ailleurs, la scalabilit√© devient beaucoup moins co√ªteuse : pas la peine de penser au d√©ploiement de nouvelles machines, ni √† la gestion de la parall√©lisation du code. L‚Äôoptimisation du code permet r√©ellement des √©conomies, puisque chaque ex√©cution du code a un co√ªt identifiable. Enfin, l‚Äôex√©cution du code sera plus √©cologique (parce qu‚Äôon consomme √©videment moins de ressources).
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-64">
<br/>
<h3 id="truecontraintes">Contraintes</h3>
<br/>
<div class="paragraph data-line-66">
</p>
<p>
Avant tout, il ya un vendor-lock-in certain : impl√©menter du serverless n√©cessite de s‚Äôadapter au fournisseur. Evidement, le m√©tier ne va pas changer. En revanche, toute la partie data/communication sera d√©pendante du fournisseur.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-69">
</p>
<p>
Par ailleurs, en termes de s√©curit√©, √ßa n‚Äôest pas forc√©ment facile. D‚Äôabord parce qu‚Äôon sort de la classique DMZ. Ensuite parce chaque fournisseur a sa propr√© impl√©mentation de politique de s√©curit√©, ce qui n√©cessite nettement une adaptation.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-72">
</p>
<p>
On ne peut bien s√ªr plus optimiser sa distribution Linux. En m√™me temps, √ßa ne sert que dans moins de 1% des cas.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-74">
</p>
<p>
Enfin, les vraies limites sont celles de l‚Äôex√©cution : le provider va limiter la dur√©e d‚Äôex√©cution, le d√©lai de d√©marrage (et √ßa, typiquement, √† part Quarkus/Micronaut, √ßa rend le Java inutilisable), la possibilit√© de faire des tests d‚Äôint√©gration, et m√™me le mode de d√©ploiement/packaging/versioning.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-76">
<br/>
<h2 id="trued_mo">D√©mo</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="sect2 data-line-78">
<br/>
<h3 id="trueserverless">serverless</h3>
<br/>
<div class="paragraph data-line-79">
</p>
<p>
Steve va faire la d√©monstration avec <a href="http://serverless.com/">serverless.com</a> (ils ont choisi le bon nom au bon moment). Normalement, l‚Äôoutil est raisonnablement agnostique (dans sa version payante au moins).
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-82">
</p>
<p>
Logan me fait imm√©diatement la remarque que l‚Äôagnosticit√© du truc est un peu limit√© : pour cr√©er son appli Python, Steve lance la commande <code>sls create -t aws-python3</code>. Et effectivement, le seul int√©r√™t est que la commande est la m√™me pour aws/azure/‚Ä¶‚Äã
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-85">
</p>
<p>
Ca cr√©e donc un squelette Python, avec un <code>serverless.yml</code> (et oui, c‚Äôest de l‚Äôinfra as code, donc c‚Äôest du YAML) qui d√©crit comment elle sera appel√©e.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-87">
</p>
<p>
Et un appel √† <code>sls deploy</code> va d√©ployer les √©l√©ments n√©cessaires pour rendre la fonction utilisable depuis AWS.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-89">
</p>
<p>
Et √ßa marche facilement !
</p>
<p>
</div>
<br/>
<div class="listingblock data-line-91">
<br/>
<div class="content">
<br/>
<pre>curl -v https://zc0tvoviak.execute-api.eu-west-1.amazonaws.com/dev/users/lille
</p>
<p>
{
<br/>
"message": "Hello Chti JUG",
<br/>
"input": {
<br/>
"resource": "/users/lille",
<br/>
"path": "/users/lille",
<br/>
"httpMethod": "GET",
<br/>
"headers": {
<br/>
"Accept": "*/*",
<br/>
"CloudFront-Forwarded-Proto": "https",
<br/>
"CloudFront-Is-Desktop-Viewer": "true",
<br/>
"CloudFront-Is-Mobile-Viewer": "false",
<br/>
"CloudFront-Is-SmartTV-Viewer": "false",
<br/>
"CloudFront-Is-Tablet-Viewer": "false",
<br/>
"CloudFront-Viewer-Country": "FR",
<br/>
"Host": "zc0tvoviak.execute-api.eu-west-1.amazonaws.com",
<br/>
"User-Agent": "curl/7.55.1",
<br/>
"Via": "1.1 351ae5c6dc020f41490e39fd18b2ac14.cloudfront.net (CloudFront)",
<br/>
"X-Amz-Cf-Id": "KkvQqh_2tZ40wbmC2Li9VGTYVg0_HhvCaYQ2gs-yKlLDuMq9OPc9Jg==",
<br/>
"X-Amzn-Trace-Id": "Root=1-5ce6dd72-a74747e4c52219abbbb04999",
<br/>
"X-Forwarded-For": "165.225.77.153, 70.132.45.71",
<br/>
"X-Forwarded-Port": "443",
<br/>
"X-Forwarded-Proto": "https"
<br/>
},
<br/>
"multiValueHeaders": {
<br/>
"Accept": ["*/*"],
<br/>
"CloudFront-Forwarded-Proto": ["https"],
<br/>
"CloudFront-Is-Desktop-Viewer": ["true"],
<br/>
"CloudFront-Is-Mobile-Viewer": ["false"],
<br/>
"CloudFront-Is-SmartTV-Viewer": ["false"],
<br/>
"CloudFront-Is-Tablet-Viewer": ["false"],
<br/>
"CloudFront-Viewer-Country": ["FR"],
<br/>
"Host": ["zc0tvoviak.execute-api.eu-west-1.amazonaws.com"],
<br/>
"User-Agent": ["curl/7.55.1"],
<br/>
"Via": ["1.1 351ae5c6dc020f41490e39fd18b2ac14.cloudfront.net (CloudFront)"],
<br/>
"X-Amz-Cf-Id": ["KkvQqh_2tZ40wbmC2Li9VGTYVg0_HhvCaYQ2gs-yKlLDuMq9OPc9Jg=="],
<br/>
"X-Amzn-Trace-Id": ["Root=1-5ce6dd72-a74747e4c52219abbbb04999"],
<br/>
"X-Forwarded-For": ["165.225.77.153, 70.132.45.71"],
<br/>
"X-Forwarded-Port": ["443"],
<br/>
"X-Forwarded-Proto": ["https"]
<br/>
},
<br/>
"queryStringParameters": null,
<br/>
"multiValueQueryStringParameters": null,
<br/>
"pathParameters": null,
<br/>
"stageVariables": null,
<br/>
"requestContext": {
<br/>
"resourceId": "so13c0",
<br/>
"resourcePath": "/users/lille",
<br/>
"httpMethod": "GET",
<br/>
"extendedRequestId": "aJeJ1FFMjoEFg9A=",
<br/>
"requestTime": "23/May/2019:17:50:42 +0000",
<br/>
"path": "/dev/users/lille",
<br/>
"accountId": "961550549303",
<br/>
"protocol": "HTTP/1.1",
<br/>
"stage": "dev",
<br/>
"domainPrefix": "zc0tvoviak",
<br/>
"requestTimeEpoch": 1558633842103,
<br/>
"requestId": "48707c94-7d83-11e9-ad78-57e2349266a5",
<br/>
"identity": {
<br/>
"cognitoIdentityPoolId": null,
<br/>
"accountId": null,
<br/>
"cognitoIdentityId": null,
<br/>
"caller": null,
<br/>
"sourceIp": "165.225.77.153",
<br/>
"principalOrgId": null,
<br/>
"accessKey": null,
<br/>
"cognitoAuthenticationType": null,
<br/>
"cognitoAuthenticationProvider": null,
<br/>
"userArn": null,
<br/>
"userAgent": "curl/7.55.1",
<br/>
"user": null
<br/>
},
<br/>
"domainName": "zc0tvoviak.execute-api.eu-west-1.amazonaws.com",
<br/>
"apiId": "zc0tvoviak"
<br/>
},
<br/>
"body": null,
<br/>
"isBase64Encoded": false
<br/>
}
<br/>
}</pre>
<br/>
</div>
<br/>
</div>
<br/>
<div class="paragraph data-line-174">
</p>
<p>
Bon, il y a un peu de fuite de donn√©es, mais dans l‚Äôensemble √ßa marche bien.
</p>
<p>
</div>
<br/>
</div>
<br/>
<div class="sect2 data-line-176">
<br/>
<h3 id="truechalice">Chalice</h3>
<br/>
<div class="paragraph data-line-178">
</p>
<p>
<a href="https://github.com/aws/chalice/">chalice</a> est un framework Python d√©di√© au serverless, qui ressemble beaucoup √† flask, mais avec certains d√©corateurs d√©di√©s. Par contre, comme vous l‚Äôaurez vu dans l‚Äôurl GitHub, c‚Äôest purement, totalement, et d√©finitivement d√©di√© √† AWS.
</p>
<p>
</div>
<br/>
<div class="paragraph data-line-181">
</p>
<p>
Et √ßa marche tout aussi bien.
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
<br/>
</div>
<br/>
<div class="sect1 data-line-183">
<br/>
<h2 id="trueconclusion">Conclusion</h2>
<br/>
<div class="sectionbody">
<br/>
<div class="paragraph data-line-184">
</p>
<p>
Si vous avez d√©ja un outillage de qualit√© (Docker, K8s), √ßa n‚Äôest pas forc√©ment n√©cessaire. Par ailleurs, vu la raret√© des d√©veloppeurs du march√© du travail, et vues les exigences du serverless, c‚Äôest clairement limitant. C‚Äôest n√©anmoins extr√™mement enthousiasmant pour les capacit√©s de scalabilit√©.
</p>
<p>
A mon avis ... on est dans une esp√®ce de mouvement d'avant-garde o√π on essaye de s'int√©grer au mieux dans un cadre financier fourni par les providers de cloud. Est-ce que c'est 'lavenir , Je n'en sais rien. En revanche, je sais que √ßa existe depuis ... un bon moment, et que √ßa ne semble pas totallement percer (mis √† part des cas bien pr√©cis).
</p>
<p>
</div>
<br/>
</div>
<br/>
</div>
</p>
++++