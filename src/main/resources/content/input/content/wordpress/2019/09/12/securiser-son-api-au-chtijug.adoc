:jbake-type: post
:jbake-status: published
:jbake-title: SÃ©curiser son API au chtijug
:jbake-tags: oauth2,rest,sÃ©curitÃ©,web,_mois_sept.,_annÃ©e_2019
:jbake-date: 2019-09-12
:jbake-depth: ../../../../
:jbake-uri: wordpress/2019/09/12/securiser-son-api-au-chtijug.adoc
:jbake-excerpt: 
:jbake-source: https://riduidel.wordpress.com/2019/09/12/securiser-son-api-au-chtijug/
:jbake-style: wordpress

++++
<!-- wp:core-embed/twitter {"url":"<div class='twitter'>
<span class="twitter_status">

	<span class="author">
	
		<a href="http://twitter.com/chtijug" class="screenName"><img src="http://pbs.twimg.com/profile_images/1179656487326617600/2uFfDuut_mini.jpg" alt="profile of Le Java User Group des Ch'tis d'un Ch'nord"/>chtijug</a>
		<span class="name">Ch'ti JUG</span>
		
	</span>
	
	<a href="https://twitter.com/chtijug/status/1Â 172Â 205Â 344Â 883Â 400Â 705" class="date">12 sept. 2019 Ã  19:48:27</a>

	<span class="content">
	
	<span class="text">ğŸ¤“ On a du monde pour la rentrÃ©e des jugs. ğŸ‘ PremiÃ¨re fois chez @EFFICOMLILLE ! Merci @Decathlon pour le sponsoring ğŸº https://t.co/0X73vM17nu</span>
	
	<span class="medias">
		<span class="media media-photo">
			<img src="http://pbs.twimg.com/media/EESCizdXUAAjIpG.jpg" alt="1Â 172Â 205Â 337Â 463Â 705Â 600"/>
		</span>
	</span>
	
	</span>
	
	
	<span class="twitter_status_end"/>
</span>
</div>","type":"rich","providerNameSlug":"","className":""} -->
<figure class="wp-block-embed-twitter wp-block-embed is-type-rich"><div class="wp-block-embed__wrapper">
<div class='twitter'>
<span class="twitter_status">

	<span class="author">
	
		<a href="http://twitter.com/chtijug" class="screenName"><img src="http://pbs.twimg.com/profile_images/1179656487326617600/2uFfDuut_mini.jpg" alt="profile of Le Java User Group des Ch'tis d'un Ch'nord"/>chtijug</a>
		<span class="name">Ch'ti JUG</span>
		
	</span>
	
	<a href="https://twitter.com/chtijug/status/1Â 172Â 205Â 344Â 883Â 400Â 705" class="date">12 sept. 2019 Ã  19:48:27</a>

	<span class="content">
	
	<span class="text">ğŸ¤“ On a du monde pour la rentrÃ©e des jugs. ğŸ‘ PremiÃ¨re fois chez @EFFICOMLILLE ! Merci @Decathlon pour le sponsoring ğŸº https://t.co/0X73vM17nu</span>
	
	<span class="medias">
		<span class="media media-photo">
			<img src="http://pbs.twimg.com/media/EESCizdXUAAjIpG.jpg" alt="1Â 172Â 205Â 337Â 463Â 705Â 600"/>
		</span>
	</span>
	
	</span>
	
	
	<span class="twitter_status_end"/>
</span>
</div>
</div></figure>
<!-- /wp:core-embed/twitter -->

<!-- wp:paragraph -->
<p>Pour la rentrÃ©e, on va parler sÃ©curisation des APIs. Jusquâ€™oÃ¹ ira-ton ? Ce sera avant tout un retour dâ€™expÃ©rience de ce qui est arrivÃ© chez Decathlon.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Il ya donc maintenant des API partout, parce que les entreprises ont pivotÃ© pour ouvrir les systÃ¨mes via ces APIs. Du coup Ã©videment la sÃ©curitÃ© ne se passe plus de la mÃªme maniÃ¨re (on ne peut plus concevoir le SI comme une citadelle). Chez lâ€™OWASP, ils mettent les API dans le futur top 10 des moyens dâ€™attaque, pas parce que câ€™est dangereux, mais parce que câ€™est un bon moyen dâ€™accÃ¨s. Evidement, il y a tout un tas de risques typiques (dÃ©ni de service, perte de rÃ©putation, â€¦â€‹)</p>
<!-- /wp:paragraph -->

<!-- wp:heading -->
<h2 id="trueles_basiques">Les basiques</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Avant tout, pensez Ã  exposer en HTTPS avec du TLS 1.2. Passez les donnÃ©es sensibles dans des headers, plutÃ´t que dans les paramÃ¨tres de requÃªtes (parce que les logs restent prÃ©sents longtemps).&#160;<strong>Ne mettez pas les secrets dans le code source !</strong></p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Dans le top 10 2017 de lâ€™OWASP, on trouve Ã©videment lâ€™injection Javascript/SQL. Ne construisez donc pas vos requÃªtes SQL Ã  la main. Bon, il faut bien noter que les frameworks actuels empÃªchent Ã§a depuis longtemps. HÃ©las, Ã§a rÃ©apparait dÃ¨s que le dÃ©veloppeur Ã©crit un morceau de requÃªte Ã  la main. Le site de lâ€™OWASP fournit par ailleurs des informations bien plus complÃ¨tes sur les injections et les dÃ©fauts de sÃ©curitÃ©.</p>
<!-- /wp:paragraph -->

<!-- wp:heading -->
<h2 id="trueoutillage_de_base">Outillage de base</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Evidement, mettre en place un API manager est une bonne pratique, parce que facilite la gestion de la sÃ©curitÃ©. De la mÃªme maniÃ¨re, utiliser un identity provider pour stocker lâ€™identitÃ©, lâ€™authentification, lâ€™autorisation est vraiment bien.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3 id="trueidentity_provider">Identity provider</h3>
<!-- /wp:heading -->

<!-- wp:heading {"level":4} -->
<h4 id="trueidentification">Identification</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Ne confondez pas lâ€™authentification et lâ€™autorisation (ou en HTTP le 401 et le 403) ! Sur ces sujets, il y a deux Ã©lÃ©ments faciles Ã  prendre en compte</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>FIDO plus dÃ©diÃ©e Ã  lâ€™authentification (qui fournit aussi les clÃ©s matÃ©rielles). Comme dans OAuth2, on trouve de plus en plus de diagrammes de sÃ©quences normalisant les processus dâ€™authentification.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Et les captchas, qui limitent les attaques en force brute.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4 id="trueautorisation">Autorisation</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Ici, on va parler dâ€™OAuth2, et son extension OpenId Connect (qui descend dâ€™OpenId, dont la promesse Ã©tait dâ€™avoir un identifiant unique partout). Le but dâ€™OAuth2, câ€™est de donner Ã  lâ€™utilisateur un token. Ce token se rÃ©cupÃ¨re Ã  travers des flows, qui nÃ©cessitent diffÃ©rents rÃ´les :</p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><li>le&#160;<strong>client</strong>&#160;fait la requÃªte (câ€™est lâ€™application cliente)</li><li>le resource server expose les donnÃ©es</li><li>le resource owner est le propriÃ©taire de la donnÃ©e exposÃ©e (qui nâ€™est pas forcÃ©ment le mÃªme que le resource server).</li><li>lâ€™authorization server vÃ©rifie les credentials de lâ€™utilisateur (Google, Facebook, Keycloak).</li></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>A partir de lÃ , on dÃ©finit diffÃ©rents flows</p>
<!-- /wp:paragraph -->

<!-- wp:list -->
<ul><li>Le&#160;<strong>code flow</strong>&#160;: dans ce cas, câ€™est le resource server qui envoie le code (envoyÃ© par le client) Ã  lâ€™authorization server pour que celui-ci envoie le token</li><li>Le&#160;<strong>code + PKCE</strong>, spÃ©cifique aux applications mobiles (et en particulier Ã  Android) qui existe essentiellement parce que toute les applications peuvent Ã©couter tous les ports en parallÃ¨le. On va ajouter au code un PKCE, gÃ©nÃ©rÃ© par lâ€™application cliente, qui permettra dâ€™obtenir le token.</li><li>le flow&#160;<strong>implicit</strong>&#160;est&#160;<strong>dÃ©prÃ©ciÃ©</strong>. Il faut le remplacer par un code + PKCE.</li><li>Entre deux serveurs, on peut utiliser le&#160;<strong>client credentials</strong>. Câ€™est un serveur qui va demander Ã  lâ€™authorization server des credentials directement.</li><li>Quand le code est totallement maÃ®trisÃ©, on peut utiliser le&#160;<strong>resource owner password credential</strong>. MÃªme si on maÃ®trise la production de lâ€™application, il est assez risquÃ©, puisque si un attaquant obtient lâ€™application, il peut attaquer le serveur facilement.</li><li>Pour les matÃ©riels dÃ©ployÃ©s chez le client (comme une freebox), il y a un&#160;<strong>device</strong>&#160;flow oÃ¹ un code Ã  4 chiffres est exposÃ© par le matÃ©riel pour que lâ€™utilisateur le saisisse dans son navigateur. Câ€™est utilisÃ© par exemple par Plex pour les applications externes (comme celle de la freebox).</li><li>Lorsquâ€™on utilise une borne, on peut utiliser le&#160;<strong>client initiated backchannel authentication</strong>.</li><li>Depuis un tÃ©lÃ©phone portable, on peut faire du SSO avec le&#160;<strong>Native SSO</strong>. La premiÃ¨re application va demander un secret SSO, qui devra Ãªtre dÃ©posÃ© dans un espace sÃ©curisÃ© du mobile. Et les autres pourront rÃ©utiliser ce secret pour se connecter.</li></ul>
<!-- /wp:list -->

<!-- wp:paragraph -->
<p>Pour une API, le token produit lors de ces flows sera passÃ© en entÃªte HTTP pour authentifier lâ€™utilisateur.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4 id="truedes_faiblesses">Des faiblesses</h4>
<!-- /wp:heading -->

<!-- wp:heading {"level":5} -->
<h5 id="truel_aglorithme_de_chifrement">Lâ€™aglorithme de chifrement</h5>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Pas dans OAuth2, mais plus dans certains Ã©lÃ©ments de base. Par exemple, choisissez des algorithmes de chiffrement asymÃ©triques, parce que Ã§a complique considÃ©rablement la vie aux attaquants.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":5} -->
<h5 id="truela_redirect_uri">La redirect URI</h5>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Le serveur dâ€™autorisation doit valider les urls de redirection, afin d'Ã©viter que les token fuitent vers dâ€™autres applications.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":5} -->
<h5 id="truele_state_oauth2">Le state OAuth2</h5>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Le state est toujours annoncÃ© comme optionnel. ConsidÃ©rez quâ€™il est obligatoire, parce quâ€™il permet de limiter les attaques. Par exemple, dans les librairies dâ€™Auth0, câ€™est le cas.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":5} -->
<h5 id="truele_logout">Le logout</h5>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Lorsquâ€™on se dÃ©connecte, le navigateur conserve un cookie de lâ€™identity provider, ce qui limite Ã©videment la capacitÃ© Ã  se dÃ©logger rÃ©ellement (sauf avec des extensions comme Cookie Autodelete).</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":5} -->
<h5 id="trueles_scopes">Les scopes</h5>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Les scopes permettent Ã  lâ€™application cliente de demander Ã  lâ€™utilisateur le consentement pour lâ€™accÃ¨s Ã  des donnÃ©es. A l'Ã¨re du RGPD, câ€™est indispensable ! En revanche, câ€™est une donnÃ©e personnelle, et pas une donnÃ©e partagÃ©e.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":5} -->
<h5 id="trueles_audiences">Les audiences</h5>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>On peut aussi crÃ©er des tokens utilisables par plusieurs API, pour peu que le token dÃ©finisse une audience plus large.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":3} -->
<h3 id="trueapi_management">API Management</h3>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>La brique dâ€™autorisation est lÃ  pour gÃ©rer des audiences et des scopes, mais pas pour gÃ©rer le mÃ©tier. Une mauvaise pratique est Ã©videment de dÃ©porter le mÃ©tier de lâ€™application dans lâ€™API Manager. En revanche, un API manager fournit un bon paquet de features</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4 id="trueapi_key">API key</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>La clÃ© dâ€™API nâ€™est pas de la sÃ©curitÃ©. En revanche, elle est trÃ¨s utile. On peut crÃ©er des analytics, des quotas, â€¦â€‹ mais pas authentifier.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4 id="truegestion_des_limites">Gestion des limites</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Lâ€™API Manager permet de crÃ©er des rate limit (nombres de requÃªtes/secondes) ou des quotas (nombre de requÃªtes/jour ou par mois) qui Ã©vitent au client dâ€™effondrer le serveur.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4 id="truecors">CORS</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Lâ€™API Manager va faciliter lâ€™implÃ©mentation de la fameuse "same origin policy" implÃ©mentÃ©e par les navigateurs. Pour Ã§a, aussi bien lâ€™appel Ã  lâ€™API quâ€™au front-end proviendra de la mÃªme URL, par exemple, mais des rÃ¨gles plus fines sont possibles.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4 id="truecircuit_breaker">Circuit breaker</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Encore un truc qui est portable par lâ€™API Manager, pour peu que lâ€™API dispose dâ€™un endpoint de healthcheck.</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4 id="trueroutage_dynamique">Routage dynamique</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>On peut faire du routage dynmaique, ce qui permet par exemple de porter de lâ€™A/B Testing, ou dâ€™autres fonctionnalitÃ©s de routage (par exemple du routage gÃ©ographique).</p>
<!-- /wp:paragraph -->

<!-- wp:heading {"level":4} -->
<h4 id="trueobservabilit">ObservabilitÃ©</h4>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Puisque lâ€™API Manager voit les diffÃ©rentes requÃªtes, il peut aussi permettre de mesurer les appels, et de fournir le top 10 des requÃªtes, etc, â€¦â€‹</p>
<!-- /wp:paragraph -->

<!-- wp:heading -->
<h2 id="trueconclusion">Conclusion</h2>
<!-- /wp:heading -->

<!-- wp:paragraph -->
<p>Alexandre nous a prÃ©sentÃ© ces slides</p>
<!-- /wp:paragraph -->

<!-- wp:core-embed/slideshare {"url":"https://www.slideshare.net/AlexandreFaria11/secure-your-api-from-basics-to-beyond-170861128","type":"rich","providerNameSlug":"","className":"wp-embed-aspect-1-1 wp-has-aspect-ratio"} -->
<figure class="wp-block-embed-slideshare wp-block-embed is-type-rich wp-embed-aspect-1-1 wp-has-aspect-ratio"><div class="wp-block-embed__wrapper">
https://www.slideshare.net/AlexandreFaria11/secure-your-api-from-basics-to-beyond-170861128
</div></figure>
<!-- /wp:core-embed/slideshare -->

<!-- wp:paragraph -->
<p>Et vous pouvez trouver les exemples dans <a href="https://github.com/lusoalex/talk-api-security">ce repository GitHub</a>.</p>
<!-- /wp:paragraph -->

<!-- wp:paragraph -->
<p>Je ne mâ€™attendais pas Ã  avoir une prÃ©sentation gÃ©nÃ©raliste sur l'Ã©cosystÃ¨me autour des API. Câ€™est intÃ©ressant, Ã©videment, mais Ã§a nâ€™adresse pas Ã  mon avis le sujet dâ€™une maniÃ¨re complÃ¨te : quâ€™est-ce qui fait une API sÃ»re ? quels sont les risques ? Je nâ€™ai aps eu de rÃ©ponse Ã  ces questions.</p>
<!-- /wp:paragraph -->
++++